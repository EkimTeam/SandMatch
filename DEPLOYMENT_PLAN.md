# План публикации SandMatch в Yandex Cloud

## Текущее состояние
- Приложение работает локально (localhost:8080)
- Django + PostgreSQL + React (Vite)
- Нет системы аутентификации
- Нет разграничения прав доступа

## Этап 1: Подготовка к публикации (ДО деплоя)

### 1.1 Аутентификация и авторизация
**Приоритет: КРИТИЧЕСКИЙ**

- [ ] Установить `django-allauth` или `djoser` для аутентификации
- [ ] Создать модель `UserProfile` с ролями:
  - `ADMIN` - полный доступ (создание/изменение/удаление турниров)
  - `VIEWER` - только просмотр (пока отключен)
  - `REGISTERED_USER` - для будущей статистики (пока отключен)
- [ ] Добавить middleware для проверки прав доступа
- [ ] Создать страницу логина в React
- [ ] Защитить все API endpoints декораторами `@permission_required`
- [ ] Добавить JWT токены для API (django-rest-framework-simplejwt)

### 1.2 Безопасность
**Приоритет: КРИТИЧЕСКИЙ**

- [ ] Переместить SECRET_KEY в переменные окружения
- [ ] Настроить ALLOWED_HOSTS для продакшена
- [ ] Включить HTTPS (SECURE_SSL_REDIRECT = True)
- [ ] Настроить CORS для фронтенда
- [ ] Добавить rate limiting для API (django-ratelimit)
- [ ] Настроить CSP (Content Security Policy)
- [ ] Включить CSRF защиту для всех форм

### 1.3 База данных
**Приоритет: ВЫСОКИЙ**

- [ ] Создать миграции для всех изменений
- [ ] Настроить резервное копирование БД
- [ ] Оптимизировать индексы для частых запросов
- [ ] Добавить `db_index=True` для полей поиска

### 1.4 Статические файлы и медиа
**Приоритет: ВЫСОКИЙ**

- [ ] Настроить `django-storages` для Yandex Object Storage
- [ ] Собрать статику: `python manage.py collectstatic`
- [ ] Настроить CDN для статических файлов
- [ ] Оптимизировать изображения (логотипы и т.д.)

### 1.5 Производительность
**Приоритет: СРЕДНИЙ**

- [ ] Настроить Redis для кэширования
- [ ] Добавить кэширование для списка турниров
- [ ] Настроить Gunicorn/uWSGI для Django
- [ ] Минифицировать и сжать frontend (Vite build)
- [ ] Настроить gzip компрессию

### 1.6 Мониторинг и логирование
**Приоритет: СРЕДНИЙ**

- [ ] Настроить Sentry для отслеживания ошибок
- [ ] Настроить логирование в файлы
- [ ] Добавить health check endpoint
- [ ] Настроить мониторинг через Yandex Monitoring

## Этап 2: Деплой в Yandex Cloud

### 2.1 Инфраструктура
**Сервисы Yandex Cloud:**

- [ ] **Yandex Compute Cloud** - виртуальная машина для Django
  - Ubuntu 22.04 LTS
  - 2 vCPU, 4 GB RAM (минимум)
  
- [ ] **Yandex Managed Service for PostgreSQL**
  - PostgreSQL 14+
  - Автоматические бэкапы
  
- [ ] **Yandex Object Storage (S3)**
  - Для статических файлов
  - Для медиа файлов
  
- [ ] **Yandex Application Load Balancer**
  - SSL сертификат (Let's Encrypt)
  - Балансировка нагрузки

### 2.2 Настройка сервера

```bash
# На виртуальной машине
sudo apt update && sudo apt upgrade -y
sudo apt install python3.11 python3-pip nginx redis-server -y

# Установка зависимостей
pip install -r requirements.txt

# Настройка Nginx
# Проксирование на Gunicorn (порт 8000)
# Раздача статики из Object Storage

# Настройка systemd для автозапуска
sudo systemctl enable sandmatch
sudo systemctl start sandmatch
```

### 2.3 CI/CD

- [ ] Настроить GitHub Actions для автодеплоя
- [ ] Создать staging окружение для тестирования
- [ ] Настроить автоматический запуск тестов перед деплоем

## Этап 3: После публикации

### 3.1 Публичный просмотр турниров
**Приоритет: ВЫСОКИЙ**

- [ ] Создать публичные endpoints без аутентификации:
  - `GET /api/tournaments/public/` - список турниров
  - `GET /api/tournaments/public/{id}/` - детали турнира
  - `GET /api/tournaments/public/{id}/results/` - результаты
- [ ] Добавить SEO мета-теги для турниров
- [ ] Создать публичную страницу турнира (share link)

### 3.2 Регистрация пользователей
**Приоритет: СРЕДНИЙ**

- [ ] Добавить форму регистрации через email
- [ ] Добавить подтверждение email
- [ ] Создать личный кабинет пользователя
- [ ] Добавить страницу статистики игрока

### 3.3 Telegram Bot
**Приоритет: ВЫСОКИЙ**

#### 3.3.1 Основной функционал бота

- [ ] Создать Telegram бота через BotFather
- [ ] Установить `python-telegram-bot` или `aiogram`
- [ ] Реализовать команды:
  - `/start` - приветствие и регистрация
  - `/tournaments` - список турниров
  - `/register {tournament_id}` - запись на турнир
  - `/mystats` - статистика пользователя
  - `/link {code}` - привязка к аккаунту в БД

#### 3.3.2 Модель данных

```python
# apps/players/models.py
class Player:
    telegram_id = models.BigIntegerField(null=True, blank=True, unique=True)
    telegram_username = models.CharField(max_length=100, null=True, blank=True)
    
class TournamentRegistration:
    tournament = models.ForeignKey(Tournament)
    player = models.ForeignKey(Player)
    registered_via = models.CharField(choices=['web', 'telegram'])
    registered_at = models.DateTimeField(auto_now_add=True)
```

#### 3.3.3 Уведомления

- [ ] Новый турнир создан (для подписчиков)
- [ ] Турнир начнется через 24 часа
- [ ] Турнир начнется через 1 час
- [ ] Ваш матч начнется через 30 минут (опционально)
- [ ] Результаты турнира опубликованы

#### 3.3.4 Webhook для бота

- [ ] Настроить webhook на `https://yourdomain.ru/api/telegram/webhook/`
- [ ] Создать endpoint для обработки сообщений от Telegram
- [ ] Настроить очередь задач (Celery + Redis) для отправки уведомлений

### 3.4 Telegram Mini App
**Приоритет: СРЕДНИЙ**

- [ ] Создать отдельное React приложение для Mini App
- [ ] Использовать Telegram WebApp API
- [ ] Реализовать функционал:
  - Просмотр списка турниров
  - Просмотр результатов турнира
  - Просмотр статистики игрока
  - Запись на турнир
- [ ] Настроить аутентификацию через Telegram initData
- [ ] Деплой Mini App на отдельный поддомен (miniapp.yourdomain.ru)

## Этап 4: Дополнительные улучшения

### 4.1 Аналитика
- [ ] Google Analytics или Yandex.Metrica
- [ ] Отслеживание популярных турниров
- [ ] Статистика использования бота

### 4.2 Производительность
- [ ] Настроить CDN для фронтенда
- [ ] Добавить Service Worker для PWA
- [ ] Оптимизировать SQL запросы (select_related, prefetch_related)

### 4.3 Резервное копирование
- [ ] Автоматические бэкапы БД (ежедневно)
- [ ] Бэкапы в Yandex Object Storage
- [ ] План восстановления после сбоя

## Оценка сроков

### Критический путь (до первой публикации):
- Аутентификация и безопасность: **5-7 дней**
- Настройка инфраструктуры Yandex Cloud: **3-5 дней**
- Деплой и тестирование: **2-3 дня**
- **ИТОГО: 10-15 дней**

### После публикации:
- Публичный просмотр: **3-5 дней**
- Telegram Bot (базовый): **7-10 дней**
- Telegram Mini App: **10-14 дней**
- Система уведомлений: **5-7 дней**
- **ИТОГО: 25-36 дней**

## Стоимость Yandex Cloud (примерная)

- Compute Cloud (VM): ~1500₽/месяц
- Managed PostgreSQL: ~2000₽/месяц
- Object Storage: ~100₽/месяц (за 10GB)
- Load Balancer: ~800₽/месяц
- **ИТОГО: ~4500₽/месяц**

## Риски и митигация

1. **Риск**: Потеря данных при миграции
   - **Митигация**: Полный бэкап перед деплоем, тестирование на staging

2. **Риск**: Проблемы с производительностью под нагрузкой
   - **Митигация**: Load testing, кэширование, масштабирование VM

3. **Риск**: Уязвимости безопасности
   - **Митигация**: Security audit, регулярные обновления, мониторинг

4. **Риск**: Сложности с интеграцией Telegram
   - **Митигация**: Поэтапная разработка, тестирование на тестовом боте

## Следующие шаги

1. Утвердить план с заказчиком
2. Создать аккаунт в Yandex Cloud
3. Начать с Этапа 1.1 (Аутентификация)
4. Параллельно подготовить инфраструктуру (Этап 2.1)
