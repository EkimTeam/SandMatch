# Telegram Bot –¥–ª—è BeachPlay

Telegram-–±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞–º–∏ –ø–æ –ø–ª—è–∂–Ω–æ–º—É —Ç–µ–Ω–Ω–∏—Å—É.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

- `/start` ‚Äî –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º (—Å –∫–Ω–æ–ø–∫–∞–º–∏ Web App)
- `/help` ‚Äî –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
- `/link <–ö–û–î>` ‚Äî –°–≤—è–∑–∞—Ç—å Telegram —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º –Ω–∞ —Å–∞–π—Ç–µ
- `/profile` ‚Äî –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/tournaments` ‚Äî –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤
- `/mytournaments` ‚Äî –ú–æ–∏ —Ç—É—Ä–Ω–∏—Ä—ã

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

1. **Telegram Mini App** üÜï
   - –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram
   - –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Ç—É—Ä–Ω–∏—Ä—ã
   - –ü—Ä–æ—Ñ–∏–ª—å —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
   - –ú–æ–∏ —Ç—É—Ä–Ω–∏—Ä—ã
   - **üìñ [–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../docs/TELEGRAM_MINI_APP.md)**
   - **‚öôÔ∏è [–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ](../../docs/MINI_APP_SETUP.md)**

2. **–°–≤—è–∑—ã–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞**
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –Ω–∞ —Å–∞–π—Ç–µ (–≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   - –°–≤—è–∑—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/link –ö–û–î`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º –∏–≥—Ä–æ–∫–∞

3. **–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è**
   - –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
   - –ò–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å (—Ä–µ–π—Ç–∏–Ω–≥, —É—Ä–æ–≤–µ–Ω—å, –≥–æ—Ä–æ–¥)
   - –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ BTR

4. **–†–∞–±–æ—Ç–∞ —Å —Ç—É—Ä–Ω–∏—Ä–∞–º–∏**
   - –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ, —Ñ–æ—Ä–º–∞—Ç–µ, —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö
   - Inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–∞–π—Ç
   - –°–ø–∏—Å–æ–∫ —Ç—É—Ä–Ω–∏—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

5. **–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** üÜï
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ç—É—Ä–Ω–∏—Ä–∞—Ö
   - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–∞—Ç—á–∞—Ö
   - Celery + Redis –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
   - **üìñ [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º](../../docs/TELEGRAM_NOTIFICATIONS_SETUP.md)**

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞

1. –ù–∞–π–¥–∏ [@BotFather](https://t.me/BotFather) –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å –∫–æ–º–∞–Ω–¥—É `/newbot`
3. –°–ª–µ–¥—É–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞
4. –°–æ—Ö—Ä–∞–Ω–∏ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å –≤ `.env` —Ñ–∞–π–ª:

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_USE_WEBHOOK=false
TELEGRAM_WEBHOOK_URL=
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–£–±–µ–¥–∏—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã:

```bash
pip install aiogram==3.4.1
pip install asgiref
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Docker:

```bash
docker-compose exec web pip install aiogram==3.4.1
```

## –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

### Development (Long Polling)

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
python manage.py run_bot

# –í Docker
docker-compose exec web python manage.py run_bot
```

### Production (Webhook)

```bash
# –ù–∞—Å—Ç—Ä–æ–π webhook URL –≤ .env
TELEGRAM_USE_WEBHOOK=true
TELEGRAM_WEBHOOK_URL=https://yourdomain.com

# –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
python manage.py run_bot --webhook
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
apps/telegram_bot/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ config.py              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ dispatcher.py          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ handlers/              # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start.py           # /start
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ link.py            # /link
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile.py         # /profile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ help.py            # /help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tournaments.py     # /tournaments, /mytournaments
‚îÇ   ‚îî‚îÄ‚îÄ keyboards/             # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ)
‚îú‚îÄ‚îÄ management/
‚îÇ   ‚îî‚îÄ‚îÄ commands/
‚îÇ       ‚îî‚îÄ‚îÄ run_bot.py         # –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
‚îú‚îÄ‚îÄ models.py                  # –ú–æ–¥–µ–ª–∏ (TelegramUser, LinkCode)
‚îî‚îÄ‚îÄ README.md                  # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è

1. –ó–∞–π–¥–∏ –Ω–∞ —Å–∞–π—Ç `http://localhost:8080/profile`
2. –ù–∞–∂–º–∏ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥¬ª –≤ —Ä–∞–∑–¥–µ–ª–µ Telegram
3. –°–∫–æ–ø–∏—Ä—É–π –∫–æ–¥
4. –û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É `/link –í–ê–®_–ö–û–î`
5. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å —Å–≤—è–∑–∏ –Ω–∞ —Å–∞–π—Ç–µ

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥

```
/start          - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
/profile        - –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
/tournaments    - –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤
/mytournaments  - –¢–≤–æ–∏ —Ç—É—Ä–Ω–∏—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
/help           - –°–ø—Ä–∞–≤–∫–∞
```

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã

1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤ `bot/handlers/`
2. –û–ø—Ä–µ–¥–µ–ª–∏ —Ä–æ—É—Ç–µ—Ä –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π —Ä–æ—É—Ç–µ—Ä –≤ `dispatcher.py`

–ü—Ä–∏–º–µ—Ä:

```python
# bot/handlers/mycommand.py
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message

router = Router()

@router.message(Command("mycommand"))
async def cmd_mycommand(message: Message):
    await message.answer("Hello from mycommand!")
```

```python
# bot/dispatcher.py
from .handlers import mycommand
dp.include_router(mycommand.router)
```

### –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

–ò—Å–ø–æ–ª—å–∑—É–π `@sync_to_async` –¥–ª—è Django ORM:

```python
from asgiref.sync import sync_to_async

@sync_to_async
def get_user(user_id):
    return User.objects.get(id=user_id)

# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
user = await get_user(123)
```

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

1. **–ù–æ–≤—ã–π —Ç—É—Ä–Ω–∏—Ä** ‚Äî –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–∞ (–¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤)
2. **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Ç—É—Ä–Ω–∏—Ä–µ** ‚Äî –∑–∞ 24 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞ (–¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞** ‚Äî –ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–∞—Ç—á–∞)

### üìñ –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

**–°–º. –ø–æ–¥—Ä–æ–±–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:** [docs/TELEGRAM_NOTIFICATIONS_SETUP.md](../../docs/TELEGRAM_NOTIFICATIONS_SETUP.md)

–í –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis –∏ Celery
- ‚úÖ –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–∞ –ø—Ä–æ–¥–µ
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–¥–º–∏–Ω–∫–æ–π
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ troubleshooting
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ .env –µ—Å—Ç—å:
CELERY_BROKER_URL=redis://redis:6379/0
TELEGRAM_BOT_TOKEN=your_token

# 2. –ó–∞–ø—É—Å—Ç–∏ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose up -d --build

# 3. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å
docker-compose ps

# 4. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏
docker-compose logs -f celery celery-beat
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# Django shell
docker-compose exec web python manage.py shell

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç—É—Ä–Ω–∏—Ä–µ
from apps.telegram_bot.tasks import send_new_tournament_notification
send_new_tournament_notification.delay(tournament_id=1)
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- [x] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Ç—É—Ä–Ω–∏—Ä–∞—Ö
- [x] –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ —Ç—É—Ä–Ω–∏—Ä–∞
- [x] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –º–∞—Ç—á–µ–π
- [ ] –ü–æ–∏—Å–∫ –ø–∞—Ä—ã –¥–ª—è –∏–≥—Ä—ã
- [ ] Telegram Mini App –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Ç—É—Ä–Ω–∏—Ä—ã
- [ ] Webhook —Ä–µ–∂–∏–º –¥–ª—è production
- [ ] API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏

## Troubleshooting

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å —Ç–æ–∫–µ–Ω –≤ `.env`
2. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω: `docker-compose exec web python manage.py run_bot`
3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: `docker-compose logs -f web`

### –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏–∏

1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∫–æ–¥ –Ω–µ –∏—Å—Ç—ë–∫ (15 –º–∏–Ω—É—Ç)
2. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–æ–¥ –≤–≤–µ–¥—ë–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã)
3. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–≤—è–∑–∞–Ω —Å –¥—Ä—É–≥–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º

### –ö–æ–º–∞–Ω–¥—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ `dispatcher.py`
2. –ü—Ä–æ–≤–µ—Ä—å –ø–æ—Ä—è–¥–æ–∫ —Ä–æ—É—Ç–µ—Ä–æ–≤ (–±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã—à–µ)
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [aiogram Documentation](https://docs.aiogram.dev/)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [BotFather](https://t.me/BotFather)
