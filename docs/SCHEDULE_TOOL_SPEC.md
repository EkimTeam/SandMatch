# Спецификация UI/UX инструмента «Расписание» (SandMatch)

Версия: 1.0

Документ является единственным источником правды для разработки инструмента «Расписание». Требования ниже обязательны к реализации. Если какой-либо пункт невозможно реализовать в текущей архитектуре — разработчик обязан зафиксировать это как блокер и согласовать изменения требований до начала разработки.

---

## 1. Цель и область

### 1.1. Цель
Инструмент «Расписание» предназначен для:

- планирования матчей по кортам и «запускам» (волнам стартов);
- ручного управления слотами через Drag-and-Drop;
- отображения конфликта игроков (один игрок не может играть параллельно на разных кортах в одном запуске) с подсветкой;
- экспорта расписания в PNG и PDF (A4) с корректным разбиением на страницы;
- онлайн-просмотра фактических начальных времен и статусов матчей через режим «таймлайн».

### 1.2. Не входит в область
- Изменение спортивной логики матчей в БД (состав участников, сетка, порядок туров) через расписание.
- Изменение самих матчей в БД при «редактировании участников» на плитке. Любые «правки участников» в расписании — только текстовые оверрайды для печати/визуализации.

---

## 2. Термины

- **Турнир/стадия**: в проекте есть мастер-турниры и стадии. Расписание может формироваться для одного или нескольких турниров/стадий.
- **Корт**: ресурс, на котором идут матчи. В расписании кортов N.
- **Запуск**: волна одновременного старта. В одном запуске на каждом корте может быть максимум один слот (слот может быть пустым).
- **Слот**: единица расписания в координатах (дата, корт, запуск). Слот может содержать:
  - матч (привязка к match_id в БД);
  - текстовый блок (информация);
  - быть пустым.
- **Глобальная пауза**: событие «на все корты» (например, церемония). В UI выглядит одной полосой на всю ширину расписания и располагается между запусками.
- **Режим “Сетка запусков”**: базовый вид расписания — таблица: строки=запуски, колонки=корты.
- **Режим “Таймлайн 15 минут”**: бесконечный вертикальный таймлайн: колонки=корты, вертикальная шкала времени с шагом 15 минут. В этом режиме плитки могут “сползать” вниз при фактических задержках.
- **Текстовый оверрайд**: пользовательское отображаемое имя/текст для матч-слота, не влияющее на БД матча.

---

## 3. Доступ и права

### 3.1. Роли
Используются роли проекта: `ADMIN`, `ORGANIZER`, `REFEREE` и др.

### 3.2. Просмотр
- Просматривать расписание можно всем, кто имеет право просмотра соответствующего турнира/стадии.
- Если расписание включает несколько турниров, права просмотра должны проверяться для каждого из них (минимальное требование — хотя бы на тот, откуда пользователь пришёл). Если это технически сложно, требуется отдельное согласование.

### 3.3. Редактирование
- Создание/редактирование расписания разрешено только:
  - `ADMIN`
  - `ORGANIZER` соответствующего турнира (или турниров), согласно текущей модели прав в проекте.
- `REFEREE` может иметь право на просмотр и онлайн-режим, но не обязан иметь право менять структуру слотов (требует уточнения, но по умолчанию — только просмотр).

### 3.4. Ограничения по статусам
- Расписание можно создавать/редактировать только для турниров/стадий в статусе **`active`**.
- Для статуса `created` создание расписания запрещено: кнопка «Составить расписание» должна быть отключена и показывать объяснение.

---

## 4. Навигация и URL

### 4.1. Вход из турнира
- На странице турнира (детальная страница/страница системы King/плей-офф) должна быть кнопка **«Расписание»**, ведущая на:
  - `/tournaments/{id}/schedule`

### 4.2. Общее расписание для нескольких турниров
Если расписание было составлено для нескольких турниров/стадий, то:

- с каждого турнира кнопка «Расписание» должна вести на это же расписание;
- пользователь не должен видеть различий в URL/внутренней структуре — переход остаётся `/tournaments/{id}/schedule`.

Требование UX:

- пользователь не должен видеть “внутренний ID расписания”;
- в заголовке расписания обязателен список турниров/стадий, включённых в расписание.

---

## 5. Визуальная структура страницы (общая)

### 5.1. Sticky Header (фиксированная шапка)
Шапка должна быть фиксированной при прокрутке.

Содержимое шапки:

1) **Заголовок**: `Расписание`

2) **Подзаголовок** (контекст):
- список турниров (через `+`): `Турнир A + Турнир B`
- при необходимости список стадий: `Стадии: ...`
- дата: `DD.MM.YYYY`

3) **Переключатель вида** (segmented control):
- `Сетка запусков`
- `Таймлайн (15 мин)`

4) **Ключевые настройки** (в одну строку на десктопе, перенос на мобильном):
- `Кортов: N` (stepper `-` `+`)
- `Матч: X мин` (селект + возможность кастомного числа минут)
- `Старт: HH:MM` (время первого запуска)
- опционально ссылка/кнопка: `Разные старты по кортам` (раскрывает компактную таблицу “корт→время первого запуска”)

5) **Действия**:
- Primary: `Составить расписание`
- Secondary: `Сохранить`, `Экспорт PNG`, `Экспорт PDF`

6) **Индикатор состояния сохранения**:
- `Сохранено HH:MM` или `Есть изменения`.
- При наличии несохранённых изменений должны быть доступны: `Сохранить` и `Отменить изменения`.

### 5.2. Левый список (Backlog)
Слева на странице должна быть панель источника элементов для D&D:

- вкладки:
  - `Матчи`
  - `Инфо-блоки`

#### 5.2.1. Вкладка «Матчи»
Содержимое:

- фильтры:
  - турниры/стадии (если несколько)
  - тип системы (RR/KO/K)
  - поиск по строке (участник/команда/матч)

- секции:
  - `Не назначены`
  - `Назначены` (для контроля)

Карточка матча в списке:

- основная строка: `Команда A vs Команда B` (или плейсхолдеры KO)
- подстрока: `Турнир • стадия/раунд` и/или `#matchId`
- бейджи: `RR/KO/K`, статус
- явный drag handle (перетаскивание разрешено только за handle)

#### 5.2.2. Вкладка «Инфо-блоки»
Содержимое:

- пресеты: `Пауза`, `Награждение`, `Церемония`, `Тренировочный корт`, `Другое`
- каждый пресет может быть перетащен в слот или между запусками (для глобальной паузы).

---

## 6. Вид 1: «Сетка запусков» (основной)

### 6.1. Общий принцип
Это основной режим построения расписания и “источник истины” структуры.

- строки = запуски
- колонки = корты
- ячейка = слот

Инвариант:

- **В одном запуске на одном корте максимум один слот**. UI не должен позволять поместить два слота в одну ячейку.

### 6.2. Представление запуска
Левый столбец фиксированный и показывает:

- `Запуск N`
- время запуска `HH:MM`

Время запуска:

- должно присутствовать всегда;
- может быть:
  - явным временем;
  - производным (“затем”/“не ранее”), но UI обязан иметь вычисленное время для проверки конфликтов и экспорта.

### 6.3. Типы содержимого ячейки

#### 6.3.1. Пустая ячейка
- визуально: легкая рамка + пустое состояние
- по hover/фокусу появляются действия:
  - `Назначить матч`
  - `Добавить текст`

#### 6.3.2. Матч-слот
Отображение внутри плитки:

- **Основной текст (крупно):** “как в расписании”
- **Подстрока (серым мелко):** `БД: ...` (исходное название матча из БД)
- Бейджи:
  - система: `RR/KO/K`
  - статус: `Запланирован` / `Идёт` / `Завершён`
- Если установлен текстовый оверрайд:
  - бейдж `Текст изменён`

#### 6.3.3. Текстовый слот (локальный)
- Заголовок (крупно)
- Подстрока (опционально)

### 6.4. Глобальная пауза (на все корты)

Требование:

- В расписании должна быть возможность вставить паузу “на все корты”, например: `14:00 — Церемония открытия`.

UI:

- Глобальная пауза отображается отдельной строкой-полосой на всю ширину таблицы (поверх всех кортов) и располагается между запусками.
- Пауза должна иметь:
  - время `HH:MM`
  - текст

Создание:

- кнопка `+ Пауза` между запусками;
- или D&D перетаскиванием инфо-блока “Пауза” на разделитель.

---

## 7. Вид 2: «Таймлайн (15 минут)»

### 7.1. Назначение
Этот режим предназначен для:

- онлайн-наблюдения за фактическими стартами и задержками;
- визуального понимания “сдвигов” времени по каждому корту.

### 7.2. Структура
- колонки = корты
- вертикальная шкала времени слева
- шаг сетки: 15 минут

### 7.3. Длительность матчей
- Длительность матча фиксируется общей настройкой (`Матч: X мин`).
- Индивидуальная длительность на слот не поддерживается.

### 7.4. Поведение “сползания” при фактических задержках

Требование:

- если фактическое время начала матча оказалось позже запланированного, плитка должна сместиться вниз по временной шкале;
- все плитки под ней на том же корте также должны сместиться вниз (накопленный лаг), чтобы визуально было видно реальные задержки.

Отображение на плитке (в таймлайне):

- `План: HH:MM`
- `Факт: HH:MM` (если известно)
- индикатор: `+Δ мин` (если факт > план)

Рекомендуемый переключатель (UX):

- `Показывать факт`: `Вкл/Выкл`.
  - `Вкл`: применяем сползание.
  - `Выкл`: показываем плановое положение.

---

## 8. Редактирование слотов (без изменения БД)

### 8.1. Общее правило
Любые правки «участников»/названий матчей в расписании — только текстовые, не изменяют матч в БД.

Пример:

- В БД RR матчи: 1-3, 1-2, 2-3.
- В расписании судья может написать:
  - `Победитель против 2`
  - `Оставшаяся игра`

Это должно быть реализовано как текстовый оверрайд слота.

### 8.2. Модалка «Редактировать слот»

Модалка обязательна для:

- матча
- текстового слота
- глобальной паузы

Поля для матча:

- `Текст в расписании` (textarea/однострочное поле — по решению разработчика)
- `Сбросить к БД` (возвращает отображаемый текст к дефолтному)
- блок “Источник (БД)” read-only

Поля для текстового слота:

- `Заголовок`
- `Подзаголовок` (опционально)

Поля для глобальной паузы:

- `Время`
- `Текст`

---

## 9. Drag-and-Drop

### 9.1. Общие правила
- Перетаскивание разрешено только за явный `drag handle`.
- Поддерживаем D&D:
  - из backlog «Матчи» в пустой слот;
  - между слотами (перемещение);
  - из расписания обратно в backlog (снять назначение);
  - инфо-блоки (текстовые) в слот;
  - пауза на все корты — на разделитель между запусками.

### 9.2. Запрет на 2 слота в одной ячейке
- Если пользователь пытается дропнуть слот в занятую ячейку:
  - по умолчанию запрещаем и показываем понятную ошибку (toast/alert): `Этот слот уже занят`.
  - опционально можно предлагать “обмен местами” (swap), но только если это явно согласовано.

---

## 10. Конфликты и подсветка

### 10.1. Основное правило конфликта
- Один и тот же игрок не может играть на разных кортах в одном запуске при условии одинакового времени старта.

Исключение:

- для кругового турнира допускается исключение, если количество кортов равно количеству матчей в туре (например, 2 корта при круговом на 4–5 игроков). Реализация исключения требует согласования алгоритма; по умолчанию конфликт считается всегда.

### 10.2. Визуализация
- Конфликтные плитки подсвечиваются розовым цветом.
- В шапке отображается счётчик конфликтов: `Конфликты: N`.
- По hover/клику по конфликтной плитке выводится причина:
  - `Конфликт: игрок X в этом запуске назначен ещё на Корт Y`.

---

## 11. Онлайн-обновления (статус и фактическое время начала)

### 11.1. Что обновляется
При просмотре расписания онлайн могут подтягиваться:

- статус матча: `scheduled`/`live`/`completed` (или эквиваленты проекта)
- фактическое время начала

### 11.2. Поведение в разных видах

- В «Сетке запусков» статус должен обновляться на карточке (бейдж).
- В «Таймлайне» статус + фактическое время должны:
  - менять бейдж статуса;
  - сдвигать плитку и плитки ниже при включенном режиме “показывать факт”.

Частота/механизм (polling/WebSocket) выбирается разработкой, но UX-результат обязателен.

---

## 12. Экспорт

### 12.1. Общие требования
- Экспорт обязан работать в двух форматах:
  - PNG
  - PDF

### 12.2. Экспорт PDF (обязательный, A4)

#### 12.2.1. Источник для PDF
PDF экспортируется из вида «Сетка запусков».

#### 12.2.2. Формат
- A4
- ориентация выбирается разработчиком, но по умолчанию — ландшафт (рекомендуется для большого числа кортов).

#### 12.2.3. Максимум кортов на страницу
- максимум кортов на одной странице PDF — **10**.
- если кортов больше 10, разбиение на страницы должно быть равномерным:
  - 12 → 6+6
  - 18 → 9+9
  - 21 → 7+7+7

#### 12.2.4. Разбиение по высоте
Если запусков много и таблица не помещается по высоте страницы, допускается разбиение по высоте на несколько страниц, при этом:

- шапка страницы и заголовки кортов должны повторяться на каждой странице.

#### 12.2.5. Состав PDF-шапки
На каждой странице PDF должны быть:

- заголовок `Расписание`
- дата
- список турниров/стадий
- легенда статусов/обозначений (компактно)

#### 12.2.6. Что исключить из экспорта
В PDF не должны попадать:

- drag handles
- кнопки
- hover подсказки
- элементы управления

Конфликты должны быть видны (розовая подсветка/штриховка + легенда).

### 12.3. Экспорт PNG
- PNG должен корректно экспортировать текущий вид (или специально подготовленный export-слой).
- Если PNG экспортируется из вида «Сетка запусков», должен совпадать по структуре с PDF.

---

## 13. Ошибки, пустые состояния, запреты

### 13.1. Нет прав
- Если пользователь не имеет прав на редактирование:
  - кнопки редактирования/создания скрыты или disabled.

### 13.2. Запрещённый статус турнира
- Если турнир/стадия не `active`, кнопка «Составить расписание» disabled и показывает объяснение.

### 13.3. Пустое расписание
- Если расписание ещё не создано:
  - показать пустое состояние с CTA `Составить расписание` (если разрешено) или текстом “Ожидает начала турнира” (если запрещено).

---

## 14. Нефункциональные требования

- Даты в UI: формат `DD.MM.YYYY`.
- Учитывать адаптивность:
  - на мобильном: переключение вида и экспорт должны оставаться доступными, таблица может быть с горизонтальным скроллом.
- Производительность:
  - таймлайн не должен лагать при большом числе запусков/кортов.

---

## 15. Критерии приёмки (Definition of Done)

Функциональность считается готовой, если:

1) Из страницы турнира можно открыть `/tournaments/{id}/schedule`.
2) В расписании виден список турниров/стадий и дата.
3) Реализованы 2 вида:
   - «Сетка запусков» (основной)
   - «Таймлайн 15 минут»
4) В сетке запусков невозможно иметь 2 слота на одном корте в одном запуске.
5) Есть слоты:
   - матч
   - текст
   - пустой
6) Есть глобальная пауза на все корты между запусками.
7) D&D работает согласно правилам.
8) Конфликтные слоты подсвечиваются розовым и есть объяснение причины.
9) В таймлайне при фактической задержке плитка съезжает вниз и сдвигает последующие плитки на том же корте.
10) Экспорт PDF работает:
   - A4
   - максимум 10 кортов на страницу
   - больше 10 — равномерное разбиение
   - корректное разбиение по высоте при необходимости
11) Экспорт PNG работает.
12) Редактирование “участников/текста” в слоте — только текстовый оверрайд, не меняющий матч в БД.

---
