# Рейтинг SandMatch

Документ описывает систему рейтинга, где хранится информация, как выполняется расчёт, как запускать пересчёт и как очищать данные по турниру.

## Ключевые сущности БД
- players_player: поле `current_rating` — текущий рейтинг игрока (целое число, неотрицательное).
- players_playerratinghistory: поматчевые изменения рейтинга.
  - `player_id`, `tournament_id`, `match_id`
  - `value` — дельта за матч (int, со знаком)
  - `reason` — техническая метка (например `fmt=1.30`)
- players_playerratingdynamic: агрегат по турниру на игрока.
  - `rating_before`, `rating_after`, `total_change`, `matches_count`, `tournament_date`
  - `meta` — список матчей с детальными метаданными (формат, рейтинг соперников и т. п.)

## Методика расчёта
- Базовая идея — модифицированный Elo.
- Рейтинг команды:
  - для одиночки: рейтинг игрока.
  - для пары: среднее двух рейтингов.
- Ожидаемый результат: `E = 1 / (1 + 10^((Ropp - Rteam)/400))`.
- Фактический результат матча: `S = 1` (победа команды) или `0` (поражение).
- Изменение: `Δ = round(K * FMT * (S - E))`, где:
  - `K = 32` (по умолчанию).
  - `FMT` — множитель формата по сетам:
    - 1 сет и это тай-брейк-матч: `0.3`.
    - 1 обычный сет: `1.0`.
    - 2+ сетов: `1.0 + (N-1)*0.1 + |diff_sets|*0.1`.
- Запись истории:
  - В `PlayerRatingHistory.value` пишется дельта ТОГО матча (не кумулятив).
  - В `PlayerRatingDynamic.total_change` — сумма дельт по всем матчам турнира для игрока.
- Применение результата турнира:
  - После обработки всех матчей турнира обноcится `Player.current_rating = rating_before + total_change`.

## Стартовые рейтинги новых игроков
Для игроков, впервые участвующих в турнире (текущий рейтинг = 0), старт задаётся по названию турнира (без учёта регистра):
- Если имя содержит `HARD` → 1100
- Если имя содержит `MEDIUM` → 900
- Иначе → 1000

Старт применяется при завершении турнира и опционально в команде пересчёта (см. ниже).

## Жизненный цикл расчёта
1. Вводятся результаты матчей (статус `COMPLETED`).
2. Нажимается кнопка «Завершить турнир» → вызов `POST /api/tournaments/<id>/complete/`.
   - Устанавливаются стартовые рейтинги участникам с `current_rating=0`.
   - Выполняется расчёт по всем завершённым матчам турнира.
   - Записываются `PlayerRatingHistory` и `PlayerRatingDynamic`, обновляется `Player.current_rating`.
   - Турнир получает статус `COMPLETED`.
   - Идемпотентность: повторный вызов блокируется, если турнир уже завершён или агрегаты существуют.

## Инструменты администрирования

### Очистка по одному турниру
Команда откатывает рейтинг и удаляет историю/агрегаты по турниру.

```
python manage.py cleanup_tournament_rating <tournament_id>
# Пробный запуск без изменений
python manage.py cleanup_tournament_rating <tournament_id> --dry-run
```
Делает:
- Вычитает `PlayerRatingDynamic.total_change` из `Player.current_rating` для всех игроков турнира.
- Удаляет записи из `PlayerRatingHistory` и `PlayerRatingDynamic` по `tournament_id`.

### Повторный пересчёт по одному турниру
```
python manage.py recompute_tournament_rating <tournament_id>
# С установкой стартовых рейтингов по методике HARD/MEDIUM/DEFAULT перед расчётом
python manage.py recompute_tournament_rating <tournament_id> --set-start
```
Делает:
- (опционально) ставит стартовые рейтинги участникам с `current_rating=0`.
- Запускает `compute_ratings_for_tournament` для всех завершённых матчей турнира.

### Полный пересчёт (на будущее)
Существующая команда для пакетного перерасчёта:
```
python manage.py recompute_ratings [--from-date YYYY-MM-DD] [--to-date YYYY-MM-DD] [--wipe-history]
```
Проверяйте параметры перед использованием — она может затронуть все турниры.

## API и фронтенд
- Завершение турнира: `POST /api/tournaments/<id>/complete/` (требует аутентификации).
- Карточка игрока:
  - История рейтинга строится из `PlayerRatingDynamic`.
  - График показывает `rating_after` по датам турниров и надписи дельт `total_change` над точками.

## Практические советы
- Перед пересчётом проблемного турнира: сначала `cleanup_tournament_rating`, затем `recompute_tournament_rating --set-start`.
- Если турнир завершали несколько раз до фиксации идемпотентности — почистите дубликаты командой очистки и вызовите пересчёт заново.
- Для BYE-матчей или матчей без обеих команд дельта = 0, история пишется с нулями только если матч завершён.
