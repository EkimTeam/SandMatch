# План реализации инструмента «Расписание» (SandMatch)

Версия: 1.0

Связанные документы:

- `docs/SCHEDULE_TOOL_SPEC.md` — функциональная спецификация (источник истины требований)

Ключевое решение (зафиксировано): **экспорт PDF реализуется на сервере**.

---

## 0. Инварианты и исходные данные проекта

### 0.1. Технологии проекта (контекст)

- Backend: Django + DRF, JWT auth, проектные permissions в `apps/accounts/permissions.py`.
- Frontend: React + TypeScript + Vite, API через `frontend/src/services/api.ts`.
- Матчи: модель `Match` содержит `status`, `started_at`, `completed_at` (используется для онлайн-таймлайна).
- В проекте уже есть:
  - подход к генерации расписаний внутри турнирных систем (RR/King) через `SchedulePattern` и эндпоинты `group_schedule`, `king_schedule`.

### 0.2. Базовые UX-инварианты (из спецификации)

- Один день = одно расписание.
- Источник истины структуры — вид «Сетка запусков».
- Один запуск = один слот на корт (слот может быть пустым). Два слота на одном корте в одном запуске — запрещено.
- Длительность матчей общая (на расписание).
- Редактирование “участников/названий” в плитке — только текстовый оверрайд, не меняющий матч в БД.
- В расписании должна быть глобальная пауза на все корты.
- PDF обязателен, формат A4, максимум 10 кортов на страницу; если кортов больше — равномерное разбиение по страницам.

---

## 1. Этап 0 — проектирование и фиксация контрактов (mini-RFC)

**Цель:** до реализации согласовать минимальный набор моделей, эндпоинтов и поведение «общего расписания».

### 1.1. Выходные артефакты

- Согласованный список API эндпоинтов (см. ниже).
- Согласованная схема хранения расписания в БД.
- Решение по PDF (уже принято): серверная генерация.

### 1.2. Ключевые вопросы для уточнения (если потребуются)

- Правила доступа при расписании на несколько турниров/стадий: проверяем права на все турниры или достаточно на турнир, из которого пришли?
- Что является «ключом» для поиска расписания по турниру: единственное расписание на дату или «последнее активное»?

---

## 2. Этап 1 — Backend: новое приложение и модели

**Цель:** создать устойчивую модель данных расписания, пригодную для сетки запусков, таймлайна и PDF.

### 2.1. Рекомендуемая структура приложения

- Создать Django app: `apps/schedules/`.
- Подключить в `INSTALLED_APPS`.

### 2.2. Модели (минимальный обязательный набор)

1) `Schedule`

- `date: DateField`
- `match_duration_minutes: PositiveSmallIntegerField`
- `created_by: FK(User)`
- `created_at/updated_at`

2) `ScheduleScope`

- `schedule: FK(Schedule)`
- `tournament: FK(Tournament)`

Назначение: одно расписание может включать несколько турниров/стадий.

3) `ScheduleCourt`

- `schedule: FK(Schedule)`
- `index: PositiveSmallIntegerField`
- `name: CharField`
- опционально: `first_start_time: TimeField(null=True)` (если нужна поддержка разных стартов по кортам)

4) `ScheduleRun`

- `schedule: FK(Schedule)`
- `index: PositiveSmallIntegerField`
- `start_mode: CharField(choices=fixed/then/not_earlier)`
- `start_time: TimeField(null=True)`
- `not_earlier_time: TimeField(null=True)`

5) `ScheduleSlot`

- `schedule: FK(Schedule)`
- `run: FK(ScheduleRun)`
- `court: FK(ScheduleCourt)`
- `slot_type: CharField(choices=match/text)` (пустые слоты не храним — UI дорисовывает)
- `match: FK(Match, null=True)`
- `text_title/text_subtitle: CharField/TextField (null=True)`
- `override_title/override_subtitle: CharField/TextField (null=True)`

6) `ScheduleGlobalBreak`

- `schedule: FK(Schedule)`
- `position: PositiveSmallIntegerField` (между какими запусками / индекс вставки)
- `time: TimeField`
- `text: CharField/TextField`

### 2.3. Миграции

- Создать миграции для всех моделей.
- Добавить индексы:
  - уникальность `(schedule, run, court)` для `ScheduleSlot`.
  - уникальность `(schedule, index)` для `ScheduleCourt` и `ScheduleRun`.

---

## 3. Этап 2 — Backend: сервисы времени и конфликтов

### 3.1. Сервис вычисления времени запусков

Создать `apps/schedules/services/time_service.py`:

- Вход:
  - `match_duration_minutes`
  - `schedule_runs` + режимы времени
  - стартовое время (глобальное/по кортам)
- Выход:
  - computed `start_time` для каждого запуска (обязателен для конфликтов/таймлайна/PDF)

### 3.2. Сервис конфликтов

Создать `apps/schedules/services/conflicts_service.py`:

- Проверка по каждому запуску:
  - собрать всех игроков из матч-слотов запуска
  - если игрок встречается >1 раза — конфликт
- Выход:
  - список конфликтных slot_id
  - объяснение конфликта (игрок + перечень кортов/слотов)

---

## 4. Этап 3 — Backend: API (DRF)

### 4.1. Эндпоинты (минимальный набор)

1) Получить расписание для турнира:

- `GET /api/tournaments/{id}/schedule/`

2) Сгенерировать/создать расписание (только `active`, только `ADMIN/ORGANIZER`):

- `POST /api/tournaments/{id}/schedule/generate/`

3) CRUD расписания:

- `GET /api/schedules/{schedule_id}/`
- `PUT/PATCH /api/schedules/{schedule_id}/`

4) Пул матчей для backlog:

- `GET /api/schedules/{schedule_id}/matches_pool/`

5) Онлайн-состояние матчей для таймлайна:

- `GET /api/schedules/{schedule_id}/live_state/`

6) Экспорт PDF:

- `GET /api/schedules/{schedule_id}/export/pdf/`

### 4.2. Permissions

- Просмотр расписания: по правилам просмотра турниров из scope.
- Редактирование/генерация: `IsAuthenticated` + роль `ADMIN/ORGANIZER` + проверка владения турниром.
- Генерация запрещена, если любой выбранный турнир/стадия не `active`.

---

## 5. Этап 4 — Backend: серверная генерация PDF (A4)

### 5.1. Принципы

- PDF генерируется из структуры «Сетка запусков».
- На страницу выводится максимум 10 кортов.
- Если кортов больше — разбиваем на несколько страниц с равномерным распределением.
- Если запусков много — разбиение по высоте на несколько страниц (повтор шапки и заголовков кортов).

### 5.2. Реализация

- Рекомендуется чистая генерация (например, ReportLab) для полного контроля разметки.
- В PDF обязательно:
  - заголовок «Расписание», дата, турниры/стадии
  - имена кортов
  - глобальные паузы на все корты
  - конфликты визуально различимы

---

## 6. Этап 5 — Frontend: маршрутизация и базовая страница

### 6.1. Роут

- Добавить маршрут: `/tournaments/:id/schedule`.

### 6.2. Интеграция кнопок

- Добавить кнопку «Расписание» на страницы:
  - круговой турнир (`TournamentDetailPage.tsx`)
  - King (`KingPage.tsx`)
  - плей-офф (страница олимпийки)

### 6.3. API клиент

- Добавить `scheduleApi` в `frontend/src/services/api.ts`.

---

## 7. Этап 6 — Frontend: UI «Сетка запусков» + редактирование слотов

- Реализовать `SchedulePage` со sticky header.
- Реализовать `RunsGridView`:
  - таблица запусков (строки) и кортов (колонки)
  - пустые слоты как пустые ячейки
  - поддержка глобальных пауз между запусками
- Реализовать модалки редактирования слота:
  - матч-слот: override текст + сброс к БД
  - текстовый слот
  - глобальная пауза

---

## 8. Этап 7 — Frontend: Drag-and-Drop и backlog

- Выбрать библиотеку D&D (рекомендуется `dnd-kit`).
- Backlog:
  - вкладки матчи/инфо-блоки
  - секции назначены/не назначены
- Ограничения:
  - запрещать дроп в занятую ячейку (без swap по умолчанию)
  - drag только за handle

---

## 9. Этап 8 — Frontend: конфликты

- Подсветка конфликтов розовым.
- Tooltip/поповер с причиной.
- Счётчик конфликтов в header.

---

## 10. Этап 9 — Frontend: таймлайн 15 минут и “сползание”

- `TimelineView`:
  - колонки=корты, вертикальная шкала времени 15 мин
  - общая длительность матча
  - режим “Показывать факт” (вкл/выкл)
- Алгоритм сползания per-court:
  - `render_start = max(plan_start, actual_start)`
  - все последующие слоты стартуют не раньше `render_start + duration`

---

## 11. Этап 10 — Экспорт с фронта

- PDF: скачивание файла с backend endpoint.
- PNG: генерация на клиенте (html2canvas) из export-слоя без кнопок/handle.

---

## 12. Этап 11 — Тестирование и приёмка

### 12.1. Backend

- Тесты permissions.
- Тесты запрета генерации при `created`.
- Тесты конфликтов.
- Тесты PDF разбиения по кортам (<=10 на страницу; >10 равномерно).

### 12.2. Frontend

- Смоук-сценарии:
  - открыть расписание из турнира
  - D&D матч → слот
  - конфликт подсветился
  - PDF скачался
  - таймлайн показывает сползание при started_at

---

## 13. Критерии готовности (DoD)

Должно совпадать с `docs/SCHEDULE_TOOL_SPEC.md` раздел 15 + обязательный серверный PDF.
