# Автоматический расчет коэффициента турнира

## Описание

Коэффициент турнира (`rating_coefficient`) автоматически рассчитывается при переходе турнира в статус **ACTIVE** (фиксация участников).

Коэффициент влияет на изменение рейтинга игроков:
```
Δ = K × FMT × (Actual − Expected) × COEF
```

## Таблица коэффициентов

Базовый коэффициент определяется по двум параметрам:
1. **Средний рейтинг участников** (строка)
2. **Количество участников** (столбец)

| Средний рейтинг | ≤8   | 9-12 | 12-16 | 17-24 | >24  |
|-----------------|------|------|-------|-------|------|
| ≤800            | 0.6  | 0.7  | 0.8   | 0.9   | 1.0  |
| 801-950         | 0.7  | 0.8  | 0.9   | 1.0   | 1.1  |
| 951-1050        | 0.8  | 0.9  | 1.0   | 1.1   | 1.2  |
| 1051-1200       | 0.9  | 1.0  | 1.1   | 1.2   | 1.3  |
| >1200           | 1.0  | 1.1  | 1.2   | 1.3   | 1.4  |

## Дополнительные бонусы

### Призовой фонд: +0.2

Если в турнире указан призовой фонд (поле `prize_fund` не пустое), к коэффициенту добавляется **+0.2**.

**Пример:**
- Средний рейтинг: 1100 (строка 951-1050)
- Участников: 15 (столбец 12-16)
- Базовый коэффициент: **1.0**
- Призовой фонд: "50000 руб"
- **Итоговый коэффициент: 1.0 + 0.2 = 1.2**

## Примеры расчета

### Пример 1: Небольшой турнир начинающих
- Участников: 6
- Средний рейтинг: 750
- Призовой фонд: нет
- **Коэффициент: 0.6**

### Пример 2: Средний турнир
- Участников: 14 (столбец 12-16)
- Средний рейтинг: 1000 (строка 951-1050)
- Призовой фонд: нет
- **Коэффициент: 1.0**

### Пример 3: Крупный турнир с призами
- Участников: 28
- Средний рейтинг: 1250
- Призовой фонд: "100000 руб"
- **Коэффициент: 1.4 + 0.2 = 1.6**

### Пример 4: Элитный турнир
- Участников: 20
- Средний рейтинг: 1350
- Призовой фонд: "500000 руб"
- **Коэффициент: 1.3 + 0.2 = 1.5**

## Технические детали

### Когда рассчитывается

Коэффициент автоматически рассчитывается при:
- Фиксации участников круговой системы (`lock_participants`)
- Фиксации участников системы "Кинг" (`lock_king_participants`)
- Фиксации участников олимпийской системы (`lock_bracket_participants`)

### Где хранится

Значение сохраняется в поле `Tournament.rating_coefficient` (тип `FloatField`).

### Можно ли изменить вручную

Да, организатор может вручную изменить коэффициент турнира в админ-панели или через API. Автоматический расчет происходит только при первой фиксации участников (переход из статуса CREATED в ACTIVE).

### Что если нет участников

Если на момент фиксации нет участников или у всех участников рейтинг = 0, используется средний рейтинг по умолчанию: **1000**.

## API

### Функция расчета

```python
from apps.tournaments.services.coefficient_calculator import auto_calculate_tournament_coefficient

# Автоматический расчет и сохранение коэффициента
coefficient = auto_calculate_tournament_coefficient(tournament_id)
```

### Ручной расчет без сохранения

```python
from apps.tournaments.services.coefficient_calculator import calculate_tournament_coefficient

coefficient = calculate_tournament_coefficient(
    avg_rating=1150,
    participants_count=18,
    has_prize_fund=True
)
# Результат: 1.1 + 0.2 = 1.3
```

## Влияние на рейтинг

Коэффициент турнира напрямую влияет на изменение рейтинга игроков:

**Без коэффициента (COEF = 1.0):**
- Победа: +16 рейтинга

**С коэффициентом (COEF = 1.5):**
- Победа: +24 рейтинга (+50% больше)

**С пониженным коэффициентом (COEF = 0.7):**
- Победа: +11 рейтинга (-30% меньше)

Это позволяет:
- Давать больше очков за крупные престижные турниры
- Давать меньше очков за небольшие тренировочные турниры
- Учитывать уровень участников (сильные игроки = выше коэффициент)
