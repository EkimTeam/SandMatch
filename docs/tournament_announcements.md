# –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∞–Ω–æ–Ω—Å–æ–≤ —Ç—É—Ä–Ω–∏—Ä–æ–≤ –≤ Telegram

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∞–Ω–æ–Ω—Å–æ–≤ —Ç—É—Ä–Ω–∏—Ä–æ–≤ –≤ Telegram —á–∞—Ç—ã/–∫–∞–Ω–∞–ª—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

1. **–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö** - `TournamentAnnouncementSettings`
2. **–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞** - `generate_announcement_text()`
3. **Celery –∑–∞–¥–∞—á–∏** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–æ–Ω—Å–æ–≤ –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
4. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤** - —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è —Ç—É—Ä–Ω–∏—Ä–∞
5. **–ê–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

## –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### TournamentAnnouncementSettings

**–§–∞–π–ª:** `apps/tournaments/models.py`

```python
class TournamentAnnouncementSettings(models.Model):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∞–Ω–æ–Ω—Å–æ–≤ —Ç—É—Ä–Ω–∏—Ä–∞ –≤ Telegram —á–∞—Ç"""
    
    tournament = models.OneToOneField(Tournament, ...)
    telegram_chat_id = models.CharField(max_length=100)
    
    # –¢—Ä–∏–≥–≥–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–∫–∏
    send_on_creation = models.BooleanField(default=False)
    send_48h_before = models.BooleanField(default=False)
    send_24h_before = models.BooleanField(default=True)
    send_2h_before = models.BooleanField(default=False)
    send_on_roster_change = models.BooleanField(default=False)
    
    # –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–æ–∫
    sent_on_creation = models.DateTimeField(null=True, blank=True)
    sent_48h_before = models.DateTimeField(null=True, blank=True)
    sent_24h_before = models.DateTimeField(null=True, blank=True)
    sent_2h_before = models.DateTimeField(null=True, blank=True)
    last_roster_change_sent = models.DateTimeField(null=True, blank=True)
    
    # –•–µ—à —Å–æ—Å—Ç–∞–≤–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    roster_hash = models.CharField(max_length=64, blank=True, default="")
```

**–ü–æ–ª—è:**

- `telegram_chat_id` - ID —á–∞—Ç–∞/–∫–∞–Ω–∞–ª–∞ Telegram (—Ñ–æ—Ä–º–∞—Ç: `-1001234567890`)
- `send_on_creation` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω—Å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞
- `send_48h_before` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞ 48 —á–∞—Å–æ–≤ –¥–æ –Ω–∞—á–∞–ª–∞
- `send_24h_before` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞ 24 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ)
- `send_2h_before` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞ 2 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞
- `send_on_roster_change` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞
- `roster_hash` - MD5 —Ö–µ—à —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∞–Ω–æ–Ω—Å–∞

### generate_announcement_text()

**–§–∞–π–ª:** `apps/tournaments/api_views.py`

–§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∞–Ω–æ–Ω—Å–∞ —Ç—É—Ä–Ω–∏—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–Ω–æ–Ω—Å–∞:**

1. –ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞
2. –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏, –¥–∞—Ç–∞, –≤—Ä–µ–º—è)
3. –í–∑–Ω–æ—Å
4. –õ–æ–∫–∞—Ü–∏—è
5. –õ–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
6. –†–µ–≥–ª–∞–º–µ–Ω—Ç
7. –°—Å—ã–ª–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (–±–æ—Ç –∏ –≤–µ–±-—Å–∞–π—Ç)
8. –°–ø–∏—Å–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:
   - üèÖ –û—Å–Ω–æ–≤–Ω–æ–π —Å–æ—Å—Ç–∞–≤
   - üß© –†–µ–∑–µ—Ä–≤–Ω—ã–π —Å–æ—Å—Ç–∞–≤
   - ü§ù –ò—â—É—Ç –ø–∞—Ä—É
9. –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```python
from apps.tournaments.api_views import generate_announcement_text

tournament = Tournament.objects.get(id=123)
text = generate_announcement_text(tournament)
```

**–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:**

- –ü–∞—Ä—ã: `–§–∞–º–∏–ª–∏—è –ò–º—è / –§–∞–º–∏–ª–∏—è –ò–º—è`
- –û–¥–∏–Ω–æ—á–∫–∏: `–§–∞–º–∏–ª–∏—è –ò–º—è`

> **–í–∞–∂–Ω–æ:** –í —Å—Ç—Ä–æ–∫–æ–≤–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞ (`Player.__str__`) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –§–∞–º–∏–ª–∏—è + –ò–º—è –±–µ–∑ –æ—Ç—á–µ—Å—Ç–≤–∞.

## Celery –∑–∞–¥–∞—á–∏

### send_tournament_announcement_to_chat()

**–§–∞–π–ª:** `apps/telegram_bot/tasks.py`

–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–Ω–æ–Ω—Å–∞ –≤ Telegram —á–∞—Ç.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `tournament_id` (int) - ID —Ç—É—Ä–Ω–∏—Ä–∞
- `trigger_type` (str) - —Ç–∏–ø —Ç—Ä–∏–≥–≥–µ—Ä–∞: `'creation'`, `'48h'`, `'24h'`, `'2h'`, `'roster_change'`

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**

1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç—É—Ä–Ω–∏—Ä –∏ –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–æ–Ω—Å–æ–≤
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–∫–ª—é—á–µ–Ω –ª–∏ –¥–∞–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –±—ã–ª –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–Ω–æ–Ω—Å (–∫—Ä–æ–º–µ `roster_change`)
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∞–Ω–æ–Ω—Å–∞ —á–µ—Ä–µ–∑ `generate_announcement_text()`
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram —á–µ—Ä–µ–∑ –±–æ—Ç–∞
6. –û–±–Ω–æ–≤–ª—è–µ—Ç timestamp –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

**–ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞:**

```python
from apps.telegram_bot.tasks import send_tournament_announcement_to_chat

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω—Å –∑–∞ 24 —á–∞—Å–∞
send_tournament_announcement_to_chat.delay(tournament_id=123, trigger_type='24h')
```

### check_upcoming_tournaments()

**–§–∞–π–ª:** `apps/telegram_bot/tasks.py`

–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å —á–µ—Ä–µ–∑ Celery Beat).

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**

1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç—É—Ä–Ω–∏—Ä—ã –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫–Ω–∞—Ö:
   - –ó–∞ 48 —á–∞—Å–æ–≤ (¬±1 —á–∞—Å)
   - –ó–∞ 24 —á–∞—Å–∞ (¬±1 —á–∞—Å)
   - –ó–∞ 2 —á–∞—Å–∞ (¬±30 –º–∏–Ω—É—Ç)

2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∞–Ω–æ–Ω—Å–æ–≤ –∑–∞–ø—É—Å–∫–∞–µ—Ç `send_tournament_announcement_to_chat()`

3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º (–∑–∞ 24 —á–∞—Å–∞)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Celery:**

```python
# sandmatch/celery.py
app.conf.beat_schedule = {
    'check-upcoming-tournaments': {
        'task': 'apps.telegram_bot.tasks.check_upcoming_tournaments',
        'schedule': crontab(minute=0),  # –ö–∞–∂–¥—ã–π —á–∞—Å
    },
}
```

## –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤

### check_roster_change_for_announcement()

**–§–∞–π–ª:** `apps/tournaments/signals.py`

–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ —Ç—É—Ä–Ω–∏—Ä–∞.

**–¢—Ä–∏–≥–≥–µ—Ä:** `post_save` –Ω–∞ `TournamentRegistration`

**–õ–æ–≥–∏–∫–∞:**

1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å—Ç–∞—Ç—É—Å–µ `MAIN_LIST`
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–æ–Ω—Å–æ–≤ —Ç—É—Ä–Ω–∏—Ä–∞
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥ `send_on_roster_change`
4. –í—ã—á–∏—Å–ª—è–µ—Ç MD5 —Ö–µ—à —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–∞–≤–∞:
   ```python
   roster_items = [f"team_{team.id}" –∏–ª–∏ f"player_{player.id}"]
   roster_hash = hashlib.md5("|".join(roster_items).encode()).hexdigest()
   ```
5. –ï—Å–ª–∏ —Ö–µ—à –∏–∑–º–µ–Ω–∏–ª—Å—è - –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –∞–Ω–æ–Ω—Å–∞
6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π —Ö–µ—à –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

### send_announcement_on_tournament_creation()

**–§–∞–π–ª:** `apps/tournaments/signals.py`

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–Ω–æ–Ω—Å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–∞.

**–¢—Ä–∏–≥–≥–µ—Ä:** `post_save` –Ω–∞ `Tournament` (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ `created=True`)

**–õ–æ–≥–∏–∫–∞:**

1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–Ω–æ–Ω—Å–æ–≤
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥ `send_on_creation`
3. –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –∞–Ω–æ–Ω—Å–∞ —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º `'creation'`

## –ê–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### TournamentAnnouncementSettingsAdmin

**–§–∞–π–ª:** `apps/tournaments/admin.py`

Django Admin –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∞–Ω–æ–Ω—Å–æ–≤.

**–°–µ–∫—Ü–∏–∏:**

1. **–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**
   - –¢—É—Ä–Ω–∏—Ä
   - ID —á–∞—Ç–∞ Telegram

2. **–¢—Ä–∏–≥–≥–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–∫–∏**
   - –í—Å–µ —Ñ–ª–∞–≥–∏ –≤–∫–ª—é—á–µ–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

3. **–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–æ–∫** (readonly, —Å–≤–µ—Ä–Ω—É—Ç–∞)
   - Timestamps –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∞–Ω–æ–Ω—Å–æ–≤

4. **–°–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** (readonly, —Å–≤–µ—Ä–Ω—É—Ç–∞)
   - –•–µ—à —Å–æ—Å—Ç–∞–≤–∞
   - –î–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
python manage.py makemigrations tournaments
python manage.py migrate
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ ID —á–∞—Ç–∞ Telegram

**–î–ª—è –∫–∞–Ω–∞–ª–∞:**
1. –°–æ–∑–¥–∞–π—Ç–µ –∫–∞–Ω–∞–ª –≤ Telegram
2. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
3. ID –∫–∞–Ω–∞–ª–∞ –∏–º–µ–µ—Ç —Ñ–æ—Ä–º–∞—Ç `-100XXXXXXXXXX`

**–î–ª—è –≥—Ä—É–ø–ø—ã:**
1. –°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É –≤ Telegram
2. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥ `getUpdates` API –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –±–æ—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID

**–ß–µ—Ä–µ–∑ API:**
```bash
curl https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–Ω–æ–Ω—Å–æ–≤ –¥–ª—è —Ç—É—Ä–Ω–∏—Ä–∞

**–ß–µ—Ä–µ–∑ Django Admin:**

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "Tournament announcement settings"
2. –ù–∞–∂–º–∏—Ç–µ "Add tournament announcement settings"
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç—É—Ä–Ω–∏—Ä
4. –£–∫–∞–∂–∏—Ç–µ ID —á–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `-1001234567890`)
5. –í–∫–ª—é—á–∏—Ç–µ –Ω—É–∂–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

**–ß–µ—Ä–µ–∑ –∫–æ–¥:**

```python
from apps.tournaments.models import Tournament, TournamentAnnouncementSettings

tournament = Tournament.objects.get(id=123)

TournamentAnnouncementSettings.objects.create(
    tournament=tournament,
    telegram_chat_id="-1001234567890",
    send_on_creation=False,
    send_48h_before=True,
    send_24h_before=True,
    send_2h_before=True,
    send_on_roster_change=True,
)
```

### 4. –ó–∞–ø—É—Å–∫ Celery

–î–ª—è —Ä–∞–±–æ—Ç—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á –Ω–µ–æ–±—Ö–æ–¥–∏–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–π Celery:

```bash
# Worker
celery -A sandmatch worker -l info

# Beat (–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫)
celery -A sandmatch beat -l info
```

### 5. –†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–æ–Ω—Å–∞

–ß–µ—Ä–µ–∑ Django shell:

```python
from apps.telegram_bot.tasks import send_tournament_announcement_to_chat

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω—Å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
send_tournament_announcement_to_chat.delay(
    tournament_id=123,
    trigger_type='roster_change'
)
```

## –¢–∏–ø—ã —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

| –¢—Ä–∏–≥–≥–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç |
|---------|----------|-------------------|
| `creation` | –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ | –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ) |
| `48h` | –ó–∞ 48 —á–∞—Å–æ–≤ | –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å |
| `24h` | –ó–∞ 24 —á–∞—Å–∞ | –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å |
| `2h` | –ó–∞ 2 —á–∞—Å–∞ | –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å |
| `roster_change` | –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞ | –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ—Å—Ç–∞–≤–µ |

## –õ–æ–≥–∏–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (48h, 24h, 2h)

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ–ª–µ `sent_*` –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
- –ï—Å–ª–∏ –∞–Ω–æ–Ω—Å —É–∂–µ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
- Timestamp –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

### –¢—Ä–∏–≥–≥–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–∞–≤–∞

- –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è MD5 —Ö–µ—à —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ö–µ—à–µ–º
- –ê–Ω–æ–Ω—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ö–µ—à–∞
- –ù–æ–≤—ã–π —Ö–µ—à —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `roster_hash`

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –í Celery –∑–∞–¥–∞—á–µ

```python
try:
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–æ–Ω—Å–∞
    ...
except Tournament.DoesNotExist:
    logger.error(f"–¢—É—Ä–Ω–∏—Ä {tournament_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
    return "–¢—É—Ä–Ω–∏—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
except Exception as e:
    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–Ω–æ–Ω—Å–∞: {e}", exc_info=True)
    return f"–û—à–∏–±–∫–∞: {e}"
```

### –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö —Å–∏–≥–Ω–∞–ª–æ–≤

```python
try:
    # –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
    ...
except Exception:
    # –ù–µ –ª–æ–º–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    pass
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ Celery

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `logger`:

```python
logger.info(f"–ê–Ω–æ–Ω—Å —Ç—É—Ä–Ω–∏—Ä–∞ {tournament.name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç {chat_id}")
logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–Ω–æ–Ω—Å–∞ —Ç—É—Ä–Ω–∏—Ä–∞ {tournament_id}: {e}")
```

### –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–æ–∫

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–æ–∂–Ω–æ –≤ Django Admin:
- –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–æ–Ω—Å–æ–≤ —Ç—É—Ä–Ω–∏—Ä–∞
- –†–∞—Å–∫—Ä–æ–π—Ç–µ —Å–µ–∫—Ü–∏—é "–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–æ–∫"
- –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ timestamps –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∞–Ω–æ–Ω—Å–æ–≤

### –•–µ—à —Å–æ—Å—Ç–∞–≤–∞

–¢–µ–∫—É—â–∏–π —Ö–µ—à —Å–æ—Å—Ç–∞–≤–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø–æ–ª–µ `roster_hash` (readonly –≤ –∞–¥–º–∏–Ω–∫–µ).

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –¢—É—Ä–Ω–∏—Ä —Å –∞–Ω–æ–Ω—Å–∞–º–∏ –∑–∞ 24 —á–∞—Å–∞

```python
# –°–æ–∑–¥–∞–µ–º —Ç—É—Ä–Ω–∏—Ä
tournament = Tournament.objects.create(
    name="–¢—É—Ä–Ω–∏—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è",
    date=timezone.now() + timedelta(days=1),
    ...
)

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–æ–Ω—Å—ã
TournamentAnnouncementSettings.objects.create(
    tournament=tournament,
    telegram_chat_id="-1001234567890",
    send_24h_before=True,
)

# –ß–µ—Ä–µ–∑ ~23 —á–∞—Å–∞ Celery –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –∞–Ω–æ–Ω—Å
```

### –ü—Ä–∏–º–µ—Ä 2: –ê–Ω–æ–Ω—Å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞

```python
TournamentAnnouncementSettings.objects.create(
    tournament=tournament,
    telegram_chat_id="-1001234567890",
    send_on_roster_change=True,
)

# –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–æ—Å—Ç–∞–≤
# –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∞–Ω–æ–Ω—Å
```

### –ü—Ä–∏–º–µ—Ä 3: –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ –≤—Å–µ–º–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏

```python
TournamentAnnouncementSettings.objects.create(
    tournament=tournament,
    telegram_chat_id="-1001234567890",
    send_on_creation=True,      # –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
    send_48h_before=True,       # –ó–∞ 2 –¥–Ω—è
    send_24h_before=True,       # –ó–∞ —Å—É—Ç–∫–∏
    send_2h_before=True,        # –ó–∞ 2 —á–∞—Å–∞
    send_on_roster_change=True, # –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
)
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è Telegram

- **Parse mode:** Markdown
- **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:**
  - –ó–∞–≥–æ–ª–æ–≤–∫–∏ (–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç)
  - –°—Å—ã–ª–∫–∏ `[—Ç–µ–∫—Å—Ç](url)`
  - –≠–º–æ–¥–∑–∏
  - –°–ø–∏—Å–∫–∏ —Å –¥–µ—Ñ–∏—Å–∞–º–∏

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- Django ORM
- Celery + Celery Beat
- aiogram (Telegram Bot API)
- hashlib (–¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ö–µ—à–µ–π)

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–æ–Ω—Å–∞: ~50-100ms (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram: ~200-500ms
- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ö–µ—à–∞ —Å–æ—Å—Ç–∞–≤–∞: <10ms

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞

1. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ –≤ –º–æ–¥–µ–ª—å `TournamentAnnouncementSettings`:
```python
send_1h_before = models.BooleanField(default=False)
sent_1h_before = models.DateTimeField(null=True, blank=True)
```

2. –û–±–Ω–æ–≤–∏—Ç–µ –∑–∞–¥–∞—á—É `check_upcoming_tournaments()`:
```python
triggers = [
    ('48h', 48, 1),
    ('24h', 24, 1),
    ('2h', 2, 0.5),
    ('1h', 1, 0.25),  # –ù–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä
]
```

3. –û–±–Ω–æ–≤–∏—Ç–µ –∑–∞–¥–∞—á—É `send_tournament_announcement_to_chat()`:
```python
elif trigger_type == "1h":
    trigger_enabled = settings.send_1h_before
    timestamp_field = "sent_1h_before"
```

4. –°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –µ—ë

### –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∞–Ω–æ–Ω—Å–∞

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `generate_announcement_text()` –≤ `apps/tournaments/api_views.py`:

```python
def generate_announcement_text(tournament) -> str:
    lines = []
    
    # –í–∞—à–∞ –∫–∞—Å—Ç–æ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞
    lines.append(f"üéæ {tournament.name}")
    ...
    
    return "\n".join(lines)
```

## Troubleshooting

### –ê–Ω–æ–Ω—Å—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∑–∞–ø—É—â–µ–Ω –ª–∏ Celery Worker –∏ Beat
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Celery –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —á–∞—Ç/–∫–∞–Ω–∞–ª –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `telegram_chat_id`

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–æ–Ω—Å–æ–≤

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è `sent_*` –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ç—É—Ä–Ω–∏—Ä–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ Celery Beat
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `roster_hash` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ê–Ω–æ–Ω—Å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å `MAIN_LIST`, `RESERVE_LIST` –∏–ª–∏ `LOOKING_FOR_PARTNER`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—è `player` –∏ `team`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ –±–ª–æ–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–æ–≤

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `apps/tournaments/models.py` - –º–æ–¥–µ–ª—å `TournamentAnnouncementSettings`
- `apps/tournaments/api_views.py` - —Ñ—É–Ω–∫—Ü–∏—è `generate_announcement_text()`
- `apps/tournaments/signals.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
- `apps/tournaments/admin.py` - –∞–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- `apps/telegram_bot/tasks.py` - Celery –∑–∞–¥–∞—á–∏
- `sandmatch/celery.py` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Celery Beat
- `apps/players/models.py` - `Player.__str__()` (—Ñ–æ—Ä–º–∞—Ç –§–ò–û)

## Changelog

### v1.0.0 (2026-01-29)
- –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∞–Ω–æ–Ω—Å–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 5 —Ç–∏–ø–æ–≤ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–∞–≤–∞ —á–µ—Ä–µ–∑ MD5 —Ö–µ—à
- –ê–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
