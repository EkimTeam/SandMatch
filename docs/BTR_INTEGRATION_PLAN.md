# План интеграции рейтингов BTR

## 1. Модели и структура данных

1. Расширить `players_player`:
   - `gender`: `CharField` с choices `male/female`, допускает `null/blank`.
   - `birth_date`: `DateField`, допускает `null/blank`.
   - `middle_name`: `CharField`, допускает `null/blank`.
   - `is_profi`: `BooleanField(default=False)`.
   - `btr_player`: `OneToOneField` на `btr.BtrPlayer`, `null=True`, `blank=True`, `on_delete=SET_NULL`, `related_name='linked_player'`.

2. Создать приложение `btr` (если его ещё нет) и модели:
   - `BtrPlayer`:
     - `external_id` (уникальный идентификатор игрока в BTR, строка);
     - ФИО и дополнительные поля (страна и т. п., по данным файлов BTR).
     - Связь с `Player` реализуется через поле `Player.btr_player`.
   - `BtrRatingSnapshot`:
     - `player = ForeignKey(BtrPlayer, related_name='snapshots')`;
     - `category` — `CharField` с choices для категорий BTR:
       - `men_double` — «Взрослые, парный, мужчины»
       - `men_mixed` — «Взрослые, смешанный, мужчины»
       - `women_double` — «Взрослые, парный, женщины»
       - `women_mixed` — «Взрослые, смешанный, женщины»
       - `junior_male` — «До 19, Юноши»
       - `junior_female` — «До 19, Девушки»
     - `rating_date` — дата снимка рейтинга (обычно месяц);
     - `rating_value` — численное значение рейтинга;
     - `rank` — позиция в рейтинге;
     - дополнительные поля при необходимости.
   - (Опционально) `BtrSourceFile` для учёта обработанных файлов:
     - `url`, `filename`, `downloaded_at`, `applied_at`, `hash` и т. п.

3. Миграции:
   - создать миграции для `players_player` и новых моделей в приложении `btr`.

## 2. Загрузка и обновление данных BTR

1. Перенести существующий прототип загрузчика из
   `BTR/1. Обновленный класс для скачивания файлов.py` в сервис Django (`apps/btr/services/downloader.py`).

2. Реализовать management-команду `fetch_btr_ratings`:
   - обойти страницу архива `https://btrussia.com/ru/cl/arkhiv`;
   - определить новые файлы (по имени и/или хэшу, сверяясь с `BtrSourceFile`);
   - скачать новые файлы в локальную директорию (например, `media/btr_raw/`);
   - записать в `BtrSourceFile` факт скачивания.

3. Интеграция с cron:
   - запускать `manage.py fetch_btr_ratings` каждый день с 1 по 5 число месяца;
   - при отсутствии новых файлов команда завершает работу без ошибок;
   - при наличии новых файлов — сохраняет их и вызывает слой парсинга.

## 3. Парсинг файлов BTR (остановиться перед детализацией логики)

1. Перенести прототип парсера из
   `BTR/BeachTennisParser v2.py` в `apps/btr/services/parser.py`.

2. Определить интерфейс функции парсинга (без финальной реализации логики):
   - вход: путь к локальному файлу, категория/метаданные;
   - выход: список структурированных записей вида:
     - `external_id`, `last_name`, `first_name`, `category`, `rating_date`, `rating_value`, `rank`, дополнительные поля.

3. Реализовать каркас кода, который:
   - для каждого нового файла вызывает парсер;
   - по результатам создаёт/обновляет `BtrPlayer` и `BtrRatingSnapshot`;
   - **подробную реализацию самого парсинга и сопоставления полей выполнить позже, совместно с пользователем**.

## 4. Связка игроков BTR и BP

1. Заполнение `Player.btr_player`:
   - в админке и/или отдельном интерфейсе добавить возможность связать `Player` с `BtrPlayer`;
   - обеспечить поиск по ФИО/дате рождения/полу для удобного сопоставления.

2. Логика использования связи:
   - если у `Player` заполнен `btr_player`, на странице игрока можно показывать раздел BTR и строить график по `BtrRatingSnapshot`;
   - если нет — раздел BTR отображает сообщение, что данных нет.

## 5. API для BTR

1. Endpoint для таблицы лидеров BTR (аналог `ratingApi.leaderboard`):
   - фильтры: поиск по имени, категория, пагинация;
   - возвращаемые данные: текущий (последний по дате) рейтинг, позиция, базовые поля игрока.

2. Endpoint для истории рейтинга BTR игрока (аналог `ratingApi.playerHistory`):
   - вход: `player_id` (наш `Player`) или `btr_player_id`;
   - выход: список `{ date, rating }` (при необходимости с категорией).

3. Не изменять существующие BP-эндпоинты; BTR реализовать параллельно.

## 6. Фронтенд: рейтинги BP и BTR

1. Страница `/rating`:
   - добавить переключатель рейтинга: `BP` / `BTR`;
   - при выборе `BP` использовать существующий API и разметку;
   - при выборе `BTR` — отдельный лидерборд по данным BTR.

2. Страница `/players`:
   - два подраздела (таба): `BP` и `BTR`;
   - поиск осуществляется в обоих разделах (в зависимости от активного таба или одновременно, по согласованию);
   - при переходе на карточку BP-игрока, если есть `btr_player`, доступен раздел BTR.

3. Страница игрока (BP):
   - два подраздела в карточке игрока: `BP` и `BTR`;
   - во вкладке `BP` — текущий график BP-рейтинга;
   - во вкладке `BTR` — график по данным `BtrRatingSnapshot` (по умолчанию по основной взрослой категории, с возможностью выбора категории при необходимости).

4. (Опционально) отдельный просмотр BTR-игроков без связанного BP-профиля.

## 7. Мониторинг и отладка

1. Логирование:
   - успешные и неуспешные скачивания файлов;
   - успешный/проблемный разбор файлов;
   - количество созданных/обновлённых игроков и снимков рейтинга.

2. Начальная миграция данных:
   - отдельная команда для первичной загрузки всех архивных файлов BTR;
   - после однократной загрузки — переход на режим ежемесячного обновления.

3. Валидация:
   - выборочно сверить рейтинги и позиции по нескольким игрокам между сайтом BTR и локальной БД;
   - убедиться, что графики корректно отображают динамику по датам.

## 8. Ограничение по реализации

- После реализации моделей, команд загрузки и каркаса парсера остановиться и продолжать детальную логику разбора файлов BTR только совместно с пользователем, по отдельному согласованию.
