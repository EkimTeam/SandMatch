# План реализации Telegram-бота для beachplay.ru

**Дата:** 08.12.2024

---

## 1. Технологии

- Django 5.0 + aiogram 3.x + Celery + Redis
- React Mini App (гибрид с классическим ботом)
- Монолит: новое приложение `apps/telegram_bot/`

---

## 2. Новые модели БД

### apps/telegram_bot/models.py
- `TelegramUser` — связь Telegram ID с User/Player
- `TournamentSubscription` — подписки на организаторов/площадки
- `PairRequest` — запросы на пару
- `NotificationLog` — лог уведомлений

### apps/venues/models.py
- `Venue` — площадки (адрес, координаты, фото, контакты)

### Изменения в Tournament
- Добавить `venue = ForeignKey(Venue)`

---

## 3. Backend API (расширение)

### Новые эндпоинты
```
/api/telegram/webhook/          # Webhook от Telegram
/api/telegram/auth/link/        # Связывание аккаунтов
/api/telegram/subscriptions/    # Управление подписками
/api/telegram/pairs/            # Поиск пары, запросы
/api/telegram/notifications/    # Настройки уведомлений
/api/venues/                    # CRUD площадок
```

---

## 4. Telegram Bot (aiogram)

### Команды для игроков
- `/start` — регистрация, связывание аккаунта
- `/tournaments` — список турниров
- `/register` — регистрация на турнир
- `/pairs` — поиск пары
- `/rating` — мой рейтинг и статистика
- `/subscriptions` — управление подписками
- `/settings` — настройки уведомлений

### Команды для организаторов
- `/my_tournaments` — мои турниры
- `/match_start` — начать матч
- `/match_score` — ввести счёт
- `/match_cancel` — отменить матч

---

## 5. Telegram Mini App

### Страницы
- Список турниров (фильтры, поиск)
- Детали турнира (расписание, результаты)
- Регистрация на турнир
- Поиск пары
- Рейтинг и статистика

---

## 6. Система уведомлений (Celery)

### События
- Открытие регистрации
- Напоминание о закрытии регистрации
- Старт турнира
- Начало матча игрока
- Результат матча
- Завершение турнира
- Изменение рейтинга
- Запрос на пару

### Настройки
- Включение/отключение по типам
- Подписки на организаторов/площадки

---

## 7. Этапы разработки

### Этап 1: Инфраструктура (1-2 недели)
1. Добавить Redis, Celery в docker-compose
2. Создать приложения `telegram_bot`, `venues`
3. Модели БД + миграции
4. Базовая настройка aiogram
5. Webhook endpoint

### Этап 2: Аутентификация (1 неделя)
1. Связывание Telegram ↔ User/Player
2. Команда `/start`
3. Генерация кодов подтверждения

### Этап 3: Функционал для игроков MVP (2-3 недели)
1. Список турниров (бот + Mini App)
2. Регистрация на турнир
3. Просмотр расписания/результатов
4. Базовые уведомления

### Этап 4: Поиск пары (1 неделя)
1. Список одиночек
2. Отправка запроса
3. Принятие/отклонение

### Этап 5: Подписки и уведомления (1-2 недели)
1. Модель Venue + CRUD
2. Подписки на организаторов/площадки
3. Celery задачи для всех типов уведомлений
4. Настройки уведомлений

### Этап 6: Функционал для организаторов (2 недели)
1. Управление матчами через бота
2. Ввод счёта
3. Уведомления участникам

### Этап 7: Рейтинг и статистика (1 неделя)
1. Просмотр рейтинга (BP, BTR)
2. История турниров
3. Статистика побед/поражений

### Этап 8: Тестирование и деплой (1 неделя)
1. Тестирование всех сценариев
2. Настройка webhook на продакшене
3. Мониторинг и логирование

---

## 8. Зависимости (requirements.txt)

```
aiogram==3.4.1
redis==5.0.1
celery==5.3.6
celery[redis]
python-telegram-bot  # Опционально для fallback
Pillow  # Для обработки фото площадок
```

---

## 9. Docker-compose изменения

```yaml
services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  
  celery:
    build: .
    command: celery -A sandmatch worker -l info
    depends_on:
      - redis
      - web
  
  celery-beat:
    build: .
    command: celery -A sandmatch beat -l info
    depends_on:
      - redis
```

---

## 10. Оценка трудозатрат

**Общая оценка:** 10-13 недель (2.5-3 месяца)

**MVP (Этапы 1-3):** 4-6 недель
- Базовый функционал для игроков
- Регистрация, просмотр турниров
- Простые уведомления

**Full (все этапы):** 10-13 недель

---

## 11. Риски и вопросы

### Технические
- Webhook требует HTTPS и публичный домен
- Celery требует мониторинга (Flower)
- Mini App требует адаптации React-компонентов

### Организационные
- Нужен Telegram Bot Token (через @BotFather)
- Настройка домена для webhook
- Тестирование с реальными пользователями

---

## 12. Следующие шаги

1. ✅ План утверждён
2. ⏳ Создать бота через @BotFather
3. ⏳ Настроить поддомен для webhook (bot.beachplay.ru)
4. ⏳ Начать Этап 1: Инфраструктура

---

**Контакты для вопросов:** Cascade AI Assistant
