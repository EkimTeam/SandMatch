# Статус проекта BeachPlay (2025-11-03)

## Кратко
Построен рабочий MVP0 на Django + PostgreSQL + React в Docker. Реализованы базовые сущности и полнофункциональный UI для круговой и олимпийской систем турниров. Ввод счёта поддерживает несколько сетов по `SetFormat` (включая тай‑брейки и решающий TB), данные восстанавливаются при загрузке. Добавлена интерактивность расписания туров, проверка занятости участников, защита завершенных турниров, удаление счетов. Экспорт PNG по кнопке «Поделиться» с бренд‑шапкой/футером.

## Что сделано
- Бэкенд и инфраструктура
  - Django-проект со структурой приложений: `players`, `teams`, `tournaments`, `matches`.
  - Docker + docker-compose, локальный запуск на http://localhost:8000.
  - Миграции Django для всех моделей, удалены устаревшие sql-файлы.
  - Пресеты: management-команды `seed_rulesets`, `reset_presets`.
  - Генерация кругового расписания: `generate_round_robin` (админка + команда).
- Модели и данные
  - `Player`, `Team` (одиночка/пара с ограничениями), `Tournament`, `TournamentEntry`, `TournamentEntryStats`.
  - `Match`, `MatchSet`, `MatchSpecialOutcome` (структура заложена, UI поддерживает ввод счёта).
- UI и логика турниров
  - Страница списка турниров: активные и история.
  - Страница турнира (круговая матрица):
    - добавление участников в таблицу;
    - Ввод счёта (несколько сетов по `SetFormat`) с подтверждением;
    - зеркальное отображение счёта во второй ячейке (например, 6:4 → 4:6);
    - восстановление счёта и live-статуса из БД при загрузке страницы;
    - автопересчёт и отрисовка тех. столбцов: победы, сеты, соотношения, геймы; расчёт «Места» по каскаду: Победы → личная встреча → Сеты соот. → личная встреча → Геймы соот. → личная встреча → дополнительные критерии (по рейтингу, затем по алфавиту);
    - экспорт PNG «Поделиться»: учитывает видимые столбцы и ФИО; в картинку не попадают служебные элементы (переключатели, чекбокс фиксации, туры, нижняя панель);
    - действия «Начать матч», «Отменить начало» (live → обычная).
  - Плей-офф UI: поддержка ввода счёта и отображение результатов.
- API: добавлен endpoint `match_save_score_full` для сохранения полного счёта матча.

## Что работает сейчас

### Круговая система
- Создание турнира с параметрами (`SetFormat`, `Ruleset`, группы, план)
- Генерация пар круговой системы (админ-действие/команда)
- Интерактивное расписание туров под таблицей:
  - Зачеркивание завершенных матчей
  - Подсветка live-матчей зеленым фоном
  - Hover-эффект с подсветкой ячеек в таблице
  - Клик на игру открывает диалог ввода счета
- Модальное окно действий с тремя состояниями (не начат / идет / завершен)
- Проверка занятости участников при начале матча
- Удаление счета для завершенных матчей
- Подсветка ячеек: live-матчи (зеленый фон + красный кружочек), победные ячейки
- Восстановление счёта/статуса при перезагрузке, зеркальное отображение
- Автоматический пересчёт агрегатов группы и ранжирование мест

### Олимпийская система
- Drag & Drop участников в слоты сетки
- Автоматическая генерация сетки и SVG-соединений
- Автопродвижение победителей
- Матч за 3-е место

### Единая модалка ввода счёта (обе системы)
- Многосетовый ввод с TB/чемпионским TB
- Быстрые пресеты счета
- Валидация по формату
- Поддержка свободного формата с ничьей
- В группах — мгновенное обновление матрицы
- В плей‑офф — сохранение всех сетов и автопродвижение

### Защита и безопасность
- Полная блокировка изменений для завершенных турниров
- Frontend и Backend проверки на всех endpoints

## Что предстоит сделать (ближайшие задачи)
- Учет решающего TB как 1:0 в агрегате «Сеты» (текущие агрегаты в группах считают TB очками; нужно конвертировать в сет победителя).
- Сортировка и критерии мест по `Ruleset` (включая h2h) и отображение в UI.
- Кнопка «Сгенерировать расписание» прямо на странице турнира (без админки).
- Экспорт/«Поделиться»: печатная версия, публичный URL и `favicon`.
- Улучшение UX модалок (клавиатура, фокус, Escape, ошибки API).

## Запуск и эксплуатация (локально)
- Сборка и запуск:
  ```bash
  docker compose up --build -d
  docker compose logs -f web
  ```
- Миграции и сервисные команды:
  ```bash
  docker compose exec web python manage.py migrate
  docker compose exec web python manage.py seed_rulesets
  docker compose exec web python manage.py generate_round_robin <tournament_id>
  ```
- Админка: http://localhost:8000/sm-admin

## Известные ограничения MVP0
- Публичного шаринга ещё нет (только локальная выгрузка PNG).
- Чемпионский тай‑брейк временно учитывается TB‑очками; в «Сеты» нужно учитывать как 1:0/0:1 (см. задачи выше).

## Ссылки на файлы
- Основной роутинг: `sandmatch/urls.py`
- API турниров/матчей: `apps/tournaments/api_views.py`, сериализатор: `apps/tournaments/serializers.py`
- Фронтенд (SPA): `frontend/src/pages/TournamentDetailPage.tsx`, `frontend/src/pages/KnockoutPage.tsx`, модалка `frontend/src/components/MatchScoreModal.tsx`
- Документация: `README.md`, `docs/DB.md`, `docs/PLAN.md`
