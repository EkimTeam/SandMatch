# План работ по соответствию законам о персональных данных (ПДн) для SandMatch

## Приоритет 1: Базовое соответствие

1. **Карта обработки ПДн (внутренний документ)**
   - Описать категории субъектов и данных.
   - Зафиксировать цели обработки, источники и места хранения.

2. **Публичная политика обработки ПДн**
   - Подготовить текст политики, отражающий фактическую обработку в SandMatch.
   - Разместить политику на сайте и добавить на неё ссылки (футер/формы регистрации).

3. **Явное согласие на обработку ПДн в интерфейсе**
   - Добавить чекбокс согласия в форму регистрации/создания аккаунта и другие формы, где вводятся ПДн.
   - Запретить отправку формы без установленного чекбокса.

4. **Хранение факта согласия**
   - Добавить поля в профиль пользователя (дата/время, версия политики, опционально IP/UA).
   - Заполнять эти поля при первичном согласии и при согласии с обновлённой версией политики.

5. **Ограничение доступа к ПДн**
   - Проверить роли и доступы к данным игроков/пользователей.
   - Убедиться, что расширенные данные (телефон, дата рождения и т.п.) не доступны публично и видны только авторизованным ролям.
   - Зафиксировать модель отображения ПДн в пользовательском интерфейсе (см. раздел «Политика отображения ПДн в UI и API» ниже).

## Приоритет 2: Права субъекта и управление данными

6. **Выгрузка данных пользователя**
   - Реализовать механизм, позволяющий по запросу сформировать пакет с данными пользователя (аккаунт, профиль игрока, регистрации, рейтинг).

7. **Удаление/анонимизация по запросу**
   - Определить модель поведения (что удаляется, что анонимизируется, что остаётся для статистики).
   - Реализовать методы анонимизации для Player/User и инструменты запуска (админка/management-команды).

8. **Сроки хранения**
   - Зафиксировать в документах сроки хранения разных категорий данных.
   - Опционально подготовить задачи по автоматизации обезличивания/очистки по истечении сроков.

## Приоритет 3: Аудит и операционные процессы

9. **Аудит действий с ПДн**
   - Определить список критичных операций (создание/изменение/удаление профилей, игроков, BTR-связок).
   - Организовать их логирование (в БД или отдельный лог-файл).

10. **Работа с инцидентами и запросами субъектов**
    - Описать процесс обработки запросов субъектов ПДн (куда пишут, сроки ответа, кто отвечает).
    - Описать и при необходимости отрепетировать базовый план действий при инциденте (утечка/несанкционированный доступ).

## Техническая реализация (по шагам)

1. Подготовить и согласовать тексты: карта обработки ПДн, политика ПДн.
2. Добавить политику на сайт и ссылки на неё.
3. Изменить формы регистрации/создания аккаунта на фронтенде (чекбокс согласия).
4. Добавить поля хранения согласия в профиль пользователя и обновить бэкенд-логику регистрации.
5. Проверить и при необходимости скорректировать доступы к ПДн в админке и пользовательском интерфейсе.
6. Спроектировать и частично реализовать выгрузку и анонимизацию данных.
7. Добавить базовый аудит действий с ПДн.


## Политика отображения ПДн в UI и API

### Общие принципы

- **Минимизация данных**
  - Публично и полупублично (страницы турниров, списки участников, поиск игроков) отображаются только те данные, которые необходимы для спортивного сервиса:
    - ФИО (first_name, last_name, patronymic) и/или `display_name`.
    - При необходимости — город (`city`).
  - Не отображаются в публичных/полупубличных местах:
    - телефон (`phone`), e-mail (`email`), дата рождения (`birth_date`), Telegram и другие контактные данные.
    - внутренние технические идентификаторы, токены и т.п.

- **Субъект видит о себе больше, чем другие**
  - В личном кабинете пользователь видит и может редактировать свои расширенные ПДн (в том числе телефон, дату рождения и т.п.).
  - В интерфейсе явно указывается, какие поля могут быть видимы другим (например, ФИО/город), а какие используются только для внутренних целей (телефон, дата рождения).

### Конкретизация по основным разделам

- **Профиль пользователя (личный кабинет)**
  - Доступны для просмотра/редактирования самим пользователем:
    - имя, фамилия, отчество;
    - e-mail;
    - телефон;
    - город;
    - дата рождения;
    - отображаемое имя (`display_name`);
    - уровень и рейтинг игрока (read-only, если данные приходят из BTR/рейтинг-системы).
  - В интерфейсе добавляются пояснения:
    - какие данные показываются только самому пользователю (телефон, дата рождения и т.п.);
    - какие данные могут выводиться в списках участников турниров (ФИО, `display_name`, город).

- **Страницы турниров и регистраций**
  - В списках участников и таблицах турниров отображаются:
    - ФИО или `display_name` участников;
    - при необходимости — город;
    - спортивные показатели (рейтинг, статус участия и т.п.).
  - Не отображаются:
    - телефон, e-mail, дата рождения, Telegram.
  - Для анонимных пользователей необходимо использовать исключительно публичный эндпоинт состояния регистрации, который не раскрывает никаких дополнительных ПДн.

- **Поиск и выбор игрока (link-player, create-player-and-link, поиск игроков для турниров)**
  - В ответах API для поиска игроков доступны:
    - ФИО;
    - `display_name`;
    - город;
    - рейтинг/уровень;
    - признак занятости (`is_occupied`) при привязке к аккаунту.
  - В ответах поиска и выбора игроков **не должны** присутствовать:
    - телефон;
    - e-mail;
    - дата рождения (кроме случаев, когда эти данные нужны самому пользователю о себе — в личном кабинете).
  - Эндпоинты поиска/списков игроков защищены `IsAuthenticated` и не доступны анонимным пользователям.


## Политика хранения и удаления ПДн (retention)

Базовые ориентиры (могут быть скорректированы в рамках договорённостей с оператором ПДн):

- **Аккаунты пользователей**
  - Активные аккаунты (есть логины/турниры/связки с игроками) хранятся без жёсткого срока, пока пользователь не запросит удаление/анонимизацию.
  - Неактивные аккаунты (нет логинов и активности длительный период, например 2–3 года):
    - могут быть помечены как «архивные»;
    - по отдельному решению оператора может быть запущена процедура анонимизации.

- **Игроки и турнирные данные**
  - Результаты турниров и статистика (включая техническую привязку к Player/Team) хранятся длительно, так как являются частью спортивной истории.
  - При запросе субъекта ПДн вместо удаления фактических результатов используется **анонимизация**:
    - из сущностей User/Player удаляются/обнуляются ПДн (ФИО, телефон, e-mail, дата рождения и др.);
    - сохраняются обезличенные статистические данные (места, рейтинги, результаты матчей).

- **Логи аудита ПДн (PDNActionLog)**
  - Логи действий с ПДн (export, anonymize и др.) хранятся не менее срока исковой давности, принятого оператором (например, 3–5 лет).
  - При необходимости может быть реализована отдельная процедура очистки старых логов с учётом юридических требований.

- **Резервные копии БД**
  - Резервные копии БД попадают под те же требования по срокам хранения.
  - Внутренними регламентами фиксируются:
    - периодичность создания бэкапов;
    - срок хранения бэкапов;
    - порядок безопасного удаления устаревших бэкапов.


## Операционные процедуры (export, anonymize, аудит)

### Запрос на выгрузку данных (export)

- Пользователь инициирует выгрузку данных через личный кабинет (кнопка «Скачать мои данные»), либо обращается через службу поддержки.
- Технически выгрузка выполняется через эндпоинт `/api/auth/profile/export/`,
  который возвращает агрегированные данные пользователя (User, профиль, связанные регистрации в турнирах и др.).
- Каждый факт экспорта фиксируется в `PDNActionLog` с указанием пользователя, источника (API), IP и User-Agent.

### Запрос на удаление/анонимизацию

- Пользователь подаёт запрос (через поддержку/форму обратной связи).
- Уполномоченное лицо (разработчик/оператор ПДн) проверяет личность пользователя и обоснованность запроса.
- Для фактического выполнения используется management-команда `anonymize_user` с идентификатором пользователя.
- Команда:
  - очищает/обезличивает ПДн пользователя и связанных сущностей;
  - сохраняет целостность турнирной статистики;
  - записывает факт действия в `PDNActionLog` (действие `anonymize`, источник `management_command`).

### Работа с журналом PDNActionLog

- Журнал `PDNActionLog` используется для:
  - доказательства факта выполнения запросов субъектов ПДн (export/anonymize и др.);
  - внутреннего расследования инцидентов, связанных с ПДн.
- Доступ к журналу имеет ограниченный круг лиц (оператор ПДн, ответственный разработчик).
- При необходимости возможно добавить удобное представление в Django admin (фильтр по пользователю, типу действия, датам),
  при этом сам admin остаётся инструментом для разработчиков/техподдержки, а не для конечных пользователей.


### Инциденты и обращения субъектов

- Все обращения по ПДн (выгрузка, исправление, анонимизация, жалобы) фиксируются во внутренней системе поддержки.
- Для каждого типа обращения существуют регламентированные сроки ответа и ответственное лицо.
- Базовый план действий при инциденте (утечка/несанкционированный доступ):
  - оперативное ограничение доступа и анализ масштабов;
  - уведомление ответственных лиц и, при необходимости, субъектов ПДн;
  - документирование причин и предпринятых мер;
  - корректировка технических и организационных мер для недопущения повторения инцидента.
