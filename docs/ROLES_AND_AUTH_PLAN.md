# План внедрения ролей и аутентификации

## 1. Роли и модель пользователей

### 1.1. Роли

Роли в системе:
- `ADMIN` — полный доступ, включая Django admin, управление пользователями и ролями, создание/удаление турниров.
- `ORGANIZER` — управление своими турнирами и игроками, без доступа к Django admin. Может создавать турниры.
- `REFEREE` — судья. Доступ только к активным турнирам, к которым он привязан, и только для операций с матчами (запуск, ввод счёта, отмена). Не видит прочие страницы.
- `REGISTERED` — зарегистрированный пользователь (болельщик/игрок), может смотреть всю статистику и турниры, редактировать только свой профиль, но не управлять турнирами.
- `ANONYMOUS` — незарегистрированный пользователь (гость).

### 1.2. Модели

1. Используем стандартную модель `auth.User`.
2. Добавляем модель профиля (условно `UserProfile`):
   - `user = OneToOneField(User, on_delete=CASCADE)`
   - `role = CharField(choices=Role.choices, default=REGISTERED)`
   - `player = ForeignKey(Player, null=True, blank=True)` — связь аккаунта с игроком.
   - Контактные поля (адрес, телефон, соцсети и т.д.) — редактируются самим пользователем и пользователями с правами ORGANIZER/ADMIN.
   - Telegram-поля (на будущее): `telegram_id`, `telegram_username`.

3. В модели `Tournament`:
   - `created_by = ForeignKey(User, null=True, blank=True, on_delete=SET_NULL, related_name="created_tournaments")` — кто создал турнир.
   - `referees = ManyToManyField(User, blank=True, related_name="refereed_tournaments")` — судьи (роль REFEREE).

## 2. Правила доступа

### 2.1. Общий обзор

- Все мутационные операции (создание/редактирование турниров, участников, матчей, регламентов, рейтингов и т.д.) должны требовать авторизации.
- Гранулярное ограничение по ролям реализуется через DRF permissions + проверки в вьюхах.

### 2.2. Доступ к страницам (SPA)

**ANONYMOUS (гость)**
- Видит: страницу статистики, страницу рейтинга.
- Не видит: страницу игроков, страницу конкретного игрока, h2h.
- На странице турниров:
  - видит только активные турниры;
  - блок завершённых турниров заменяется текстом «Зарегистрируйтесь, чтобы видеть завершенные турниры»;
  - кнопка «Начать новый турнир» скрыта.
- Детали турнира (любой системы) доступны только если статус турнира `active`.
- На страницах турниров (RR/KO/King):
  - доступны только кнопки отображения статистики и имён (`Победы/сеты/...`, `ФИО показать`) и «Поделиться» (если решим её оставить для гостей);
  - чекбоксы фиксации, выпадающий «Регламент», любые кнопки/клики, открывающие модальные окна матчей, скрыты.
- Доступ к Django admin запрещён (403 / SPA-экран «У вас нет доступа к этой странице»).

**REGISTERED (зарегистрированный пользователь)**
- Видит: статистику, рейтинг, список игроков, карточку любого игрока (без персональных данных других игроков — адресов, телефонов, соцсетей и т.п.).
- На своей карточке игрока (если профиль привязан к Player) может редактировать личные данные (ФИО, контакты), но не рейтинг.
- Видит любую h2h-страницу.
- На странице турниров видит активные и завершённые турниры, но кнопка «Начать новый турнир» скрыта.
- Детали турнира доступны, если статус `active` или `completed`.
- На страницах турниров RR/KO/King:
  - те же ограничения, что для ANONYMOUS (только просмотр: кнопки вида/поделиться, без фиксаций, регламентов, модалок матчей).
- Доступ к Django admin запрещён.

**ORGANIZER (организатор турниров)**
- Видит все страницы (статистика, рейтинг, игроки, турниры).
- Может создавать новые турниры (кнопка «Начать новый турнир» видна).
- В `Tournament.created_by` сохраняется создатель.
- Право редактировать турнир и вводить счёт:
  - может редактировать турнир, его участников, расписание и вводить/обновлять/сбрасывать счёт **только если он является `created_by` этого турнира**;
  - ADMIN при этом всегда имеет право редактировать любой турнир.
- Нет доступа к Django admin.

**REFEREE (судья)**
- Не видит общие страницы (статистика, рейтинг, список игроков, карточки игроков, список турниров).
- После логина судья попадает на «страницу судьи»:
  - backend отдаёт список активных турниров, где пользователь включён в `tournament.referees`;
  - если список пуст — отображается сообщение: «Нет активных турниров для судейства».
- Внутри турнира с `status=active`, где пользователь является рефери:
  - может:
    - запускать матчи (start),
    - вводить счёт (save score),
    - отменять/сбрасывать матчи (по согласованному набору действий);
  - не может:
    - менять параметры турнира (название, дата, регламент, режим расчёта, participant_mode и т.п.),
    - менять состав участников и структуру сетки,
    - пользоваться кнопкой «Поделиться»;
    - выполнять любые другие операции, кроме строго матчевых.
- Для турниров, к которым рефери не привязан, он не имеет доступа даже по прямой ссылке.

**ADMIN (администратор)**
- Полный доступ к системе, включая:
  - Django admin,
  - управление пользователями и их ролями,
  - назначение организаторов и рефери на турниры,
  - создание/редактирование/удаление любых турниров и матчей.
- Удалить турнир может только ADMIN.

### 2.3. Backend-права (DRF permissions)

План по permissions:

1. Создать перечисление ролей (например, в `apps.accounts.constants` или аналогичном модуле):
   - `Role.ADMIN`, `Role.ORGANIZER`, `Role.REFEREE`, `Role.REGISTERED`.

2. Базовые permission-классы DRF:
   - `IsAuthenticatedAndRoleIn(allowed_roles)` — проверка роли.
   - `IsAdmin` — проверка `role == ADMIN`.
   - `IsTournamentCreatorOrAdmin` — проверяет, что `tournament.created_by == request.user` или роль ADMIN.
   - `IsRefereeForTournament` — проверяет, что пользователь включён в `tournament.referees`.

3. Для мутаций турниров:
   - Создание турнира: `IsAuthenticated` + роль в {ORGANIZER, ADMIN}.
   - Редактирование параметров турнира/участников/расписания: `IsTournamentCreatorOrAdmin`.
   - Удаление турнира (backend): отдельный permission `IsTournamentCreatorOrAdminForDeletion`, который даёт право:
     - создателю удалять только свои незавершённые турниры;
     - ADMIN/staff/superuser — удалять любые турниры;
     - другим ORGANIZER/REFEREE/REGISTERED — никогда не даёт права удаления.

4. Для матчевых действий:
   - `match_start`, `match_save_score`, `match_cancel`, `match_reset`:
     - разрешено, если:
       - `IsTournamentCreatorOrAdmin` **или** `IsRefereeForTournament`;
     - при этом для REFEREE дополнительно ограничиваем список доступных действий (запрещаем, например, изменение регламента через те же вьюхи).

5. Для просмотрных API (статистика, рейтинг, турниры, игроки):
   - Ограничения реализовать либо через permissions (ограничение доступа полностью), либо через фильтрацию на уровне queryset/serializer (например, скрыть завершённые турниры для ANONYMOUS, скрыть персональные поля игроков для REGISTERED).

## 3. Аутентификация, регистрация и привязка к игрокам / Telegram

Краткий план (подробная реализация будет в отдельном техническом плане, при необходимости):

1. Аутентификация:
   - Использовать Django auth + DRF JWT (simplejwt).
   - Эндпоинты: `/api/auth/register/`, `/api/auth/login/`, `/api/auth/refresh/`, `/api/auth/logout/`, `/api/auth/password/reset/`, `/api/auth/password/reset/confirm/`.

2. Регистрация и привязка к `Player`:
   - При регистрации собираем email, пароль, ФИО и опциональные контактные данные.
   - Пытаемся найти кандидатов в `Player` по фамилии/имени (и, возможно, году рождения); при множестве совпадений — показываем выбор.
   - Привязку можно отложить и дать возможность сделать её позже через UI и/или через организатора.

3. Telegram-бот:
   - В `UserProfile` храним `telegram_id` и `telegram_username`.
   - Для привязки используем одноразовый токен (генерируем в кабинете, пользователь вводит его боту).
   - Для авторизации из бота — отдельный endpoint, возвращающий одноразовую ссылку/токен для входа в веб.

## 4. Реализация по шагам

1. **Модели и роли**
   - Создать `UserProfile` и перечисление ролей (ADMIN, ORGANIZER, REFEREE, REGISTERED).
   - Миграции для `Tournament.created_by` и `Tournament.judges`.

2. **Permissions на backend**
   - Реализовать DRF-permissions для ролей и турниров.
   - Применить их к ключевым вьюхам: турниры, матчи, статистика, рейтинг, игроки.

3. **Аутентификация и регистрация**
   - Настроить JWT, эндпоинты регистрации/логина/сброса пароля.
   - Фронтенд: добавить формы логина/регистрации и хранение токена.

4. **UI по ролям на фронте**
   - Ввести глобальное состояние текущего пользователя (роль, profile, привязка к Player).
   - Скрывать/показывать элементы UI (кнопки, вкладки, секции) согласно матрице прав.

5. **Интерфейс рефери (REFEREE)**
   - Страница «мои активные турниры для судейства».
   - Ограниченный UI в деталях турнира: только управление матчами.

6. **Дальнейшее развитие**
   - Реализовать редактирование расширенного профиля игрока.
   - Тонкая настройка логирования и аудита действий (кто что сделал и когда).
