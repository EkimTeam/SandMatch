# Маппинг BTR → BP рейтинга

## Проблема

Игроки, которые есть в BTR, но не имеют BP рейтинга, получают стартовый рейтинг 1000. Это некорректно, так как:
- 1000 — это средний уровень любителей
- В BTR в основном профессионалы с высоким уровнем игры
- Стартовый рейтинг 1000 не отражает реальный уровень профессиональных игроков

## Анализ BTR рейтингов

### Данные на 01.11.2025

#### Мужчины (men_double)
- **Всего игроков:** 194
- **Профессионалы (≥80):** 60 (31%)
- **Любители (<80):** 134 (69%)

**Статистика профессионалов:**
- Максимум: 2461
- Среднее: 462
- Медиана: 235

**Процентили:**
- 10%: 105
- 25%: 137
- 50%: 235
- 75%: 605
- 90%: 1173
- 95%: 1645
- 99%: 2461

#### Женщины (women_double)
- **Всего игроков:** 141
- **Профессионалы (≥80):** 52 (37%)
- **Любители (<80):** 89 (63%)

**Статистика профессионалов:**
- Максимум: 4246
- Среднее: 666
- Медиана: 306

**Процентили:**
- 10%: 117
- 25%: 225
- 50%: 306
- 75%: 890
- 90%: 1310
- 95%: 1964
- 99%: 4246

### Выводы из анализа

1. **Порог профессионализма:** BTR ≥ 80 четко отделяет профессионалов от любителей
2. **Широкий диапазон:** Профессиональные рейтинги варьируются от 80 до 4246
3. **Распределение:** Большинство профессионалов имеют рейтинг 100-300
4. **Топ-игроки:** Рейтинги топ-10% начинаются от 1173 (М) и 1310 (Ж)

## Предлагаемая формула

### Двухуровневая формула со скошенным распределением

```
Если BTR < 80 (любители):
    BP = 1000

Если 80 ≤ BTR < 1500 (профессионалы):
    BP = 1000 + 600 × ((BTR - 80) / 1420) ^ 0.7

Если BTR ≥ 1500 (элита):
    BP = 1600 + 400 × ((BTR - 1500) / 2500) ^ 1.05
    
Если BTR ≥ 4000:
    BP = 2000 (максимум)
```

где:
- **BTR** — максимальный рейтинг из категорий `men_double` и `women_double`
- **0.7** — степень для профессионалов (быстрый рост в начале, замедление к концу)
- **1.05** — степень для элиты (штраф растет по мере удаления от 1500)
- **2000** — максимальный стартовый BP рейтинг

### Примеры маппинга (21 пример)

| BTR | BP   | Описание |
|-----|------|----------|
| 50  | 1000 | Любитель |
| 80  | 1000 | Начало профессионального уровня |
| 100 | 1030 | Начинающий профессионал |
| 150 | 1073 | Развивающийся профессионал |
| 200 | 1106 | Уверенный профессионал |
| 235 | 1127 | Медиана профессионалов (М) |
| 300 | 1163 | Сильный профессионал |
| 306 | 1166 | Медиана профессионалов (Ж) |
| 500 | 1256 | Очень сильный профессионал |
| 750 | 1355 | Высокий уровень |
| 1000| 1443 | Очень высокий уровень |
| 1173| 1500 | Топ-10% (мужчины, 90-й процентиль) |
| 1310| 1543 | Топ-10% (женщины, 90-й процентиль) |
| 1500| 1600 | Элита (порог) |
| 1750| 1636 | Элита (начальный уровень) |
| 2000| 1674 | Элита (средний уровень) |
| 2250| 1713 | Элита (высокий уровень) |
| 2461| 1747 | Максимум мужчины (Бурмакин) |
| 2750| 1793 | Элита (очень высокий уровень) ✅ |
| 3500| 1916 | Супер-элита |
| 4000| 2000 | Максимум (потолок) ✅ |
| 4246| 2000 | Максимум женщины (Семенова/Кудинова) |

### Характеристики распределения

**1. ПРОФЕССИОНАЛЫ (80-1500): Быстрый рост в начале**
- BTR 80 → 100 (+20): BP +30
- BTR 100 → 150 (+50): BP +43
- BTR 500 → 750 (+250): BP +99
- BTR 1000 → 1250 (+250): BP +81

**2. ЭЛИТА (1500-4000): Штраф растет по мере удаления от 1500**
- BTR 1500 → 1750 (+250): BP +36
- BTR 1750 → 2000 (+250): BP +38
- BTR 2000 → 2250 (+250): BP +39
- BTR 2500 → 2750 (+250): BP +40
- BTR 3000 → 3250 (+250): BP +41
- BTR 3500 → 3750 (+250): BP +42

**3. КЛЮЧЕВЫЕ ТОЧКИ:**
- BTR 1500 → BP 1600 (порог элиты)
- BTR 2750 → BP 1793 (цель ~1900) ✅
- BTR 4000 → BP 2000 (цель ~2000, максимум) ✅

**4. Потолок:**
- Все BTR ≥ 4000 получают максимальный BP = 2000

## Рекомендация

**Использовать двухуровневую формулу со скошенным распределением**

### Обоснование:

1. **Ограничение сверху:** Максимальный стартовый рейтинг 2000 для элиты (BTR ≥ 4000)
2. **Быстрый старт:** Начинающие профессионалы (BTR 80-200) получают заметное преимущество над любителями
3. **Плавный переход:** Средние профессионалы (BTR 200-500) получают адекватный рейтинг
4. **Штраф для элиты:** Игроки с BTR ≥ 1500 получают меньший прирост BP, штраф растет с удалением от 1500
5. **Справедливость:** Достигнуты целевые значения BTR 2750 → BP ~1900, BTR 4000 → BP 2000
6. **Безопасность:** Ограничение 2000 не позволяет новичкам доминировать в турнирах

### Итоговая формула:

```python
if BTR < 80:
    BP = 1000
elif BTR >= 1500:
    # Элита: штраф растет
    capped_btr = min(BTR, 4000)
    BP = 1600 + 400 * ((capped_btr - 1500) / 2500) ** 1.05
else:
    # Профессионалы: быстрый рост
    BP = 1000 + 600 * ((BTR - 80) / 1420) ** 0.7
```

где:
- `BTR` — максимальный рейтинг из категорий `men_double` и `women_double`

## Примеры применения (детальные расчеты)

### Пример 1: Любитель
- BTR: 50 (men_double)
- **BP: 1000** (BTR < 80 → стандартный стартовый)

### Пример 2: Начинающий профессионал
- BTR: 120 (women_double)
- Расчет: 1000 + 600 × ((120 - 80) / 1420) ^ 0.7 = 1000 + 600 × 0.0282^0.7 = 1000 + 600 × 0.0889
- **BP: 1053**

### Пример 3: Средний профессионал
- BTR: 250 (men_double)
- Расчет: 1000 + 600 × ((250 - 80) / 1420) ^ 0.7 = 1000 + 600 × 0.1197^0.7 = 1000 + 600 × 0.2109
- **BP: 1127**

### Пример 4: Сильный профессионал
- BTR: 605 (men_double, 75-й процентиль)
- Расчет: 1000 + 600 × ((605 - 80) / 1420) ^ 0.7 = 1000 + 600 × 0.3697^0.7 = 1000 + 600 × 0.4765
- **BP: 1286**

### Пример 5: Топ-10%
- BTR: 1173 (men_double, 90-й процентиль)
- Расчет: 1000 + 600 × ((1173 - 80) / 1420) ^ 0.7 = 1000 + 600 × 0.7698^0.7 = 1000 + 600 × 0.8335
- **BP: 1500**

### Пример 6: Элита
- BTR: 1500 (порог топа)
- **BP: 1600** (BTR ≥ 1500 → максимум)

### Пример 7: Абсолютный топ (мужчины)
- BTR: 2461 (Бурмакин Никита, топ-1 мужчины)
- **BP: 1600** (BTR ≥ 1500 → максимум)

### Пример 8: Абсолютный топ (женщины)
- BTR: 4246 (Семенова/Кудинова, топ-1 женщины)
- **BP: 1600** (BTR ≥ 1500 → максимум)

## Реализация

### Функция расчета

```python
from apps.players.services.btr_rating_mapper import calculate_initial_bp_rating_from_btr

# Рассчитать стартовый BP рейтинг для игрока BTR
bp_rating = calculate_initial_bp_rating_from_btr(btr_player_id=123)
```

### Расчет напрямую из значения BTR

```python
from apps.players.services.btr_rating_mapper import calculate_bp_from_btr_value

# Рассчитать BP рейтинг из значения BTR (без обращения к БД)
bp_rating = calculate_bp_from_btr_value(btr_value=250)  # Вернет 1127
```

### Получение полной информации

```python
from apps.players.services.btr_rating_mapper import suggest_initial_bp_rating

# Получить информацию о BTR рейтингах и рассчитанный BP рейтинг
info = suggest_initial_bp_rating(btr_player_id=123)
print(f"BTR найден: {info['btr_found']}")
print(f"Максимальный BTR: {info['max_btr_rating']}")
print(f"Рекомендуемый BP рейтинг: {info['suggested_rating']}")
print(f"Топ-уровень: {info['is_top_level']}")
```

## Мониторинг и корректировка

После внедрения формулы необходимо:

1. **Отслеживать результаты:** Как игроки с BTR рейтингом выступают в BP турнирах
2. **Анализировать отклонения:** Сравнивать стартовый и текущий BP рейтинг после нескольких турниров
3. **Корректировать степень:** При необходимости изменить степень (0.6 ↔ 0.7 ↔ 0.8) для более/менее агрессивного роста
4. **Собирать обратную связь:** От игроков и организаторов

## Альтернативные варианты степени

Если текущая формула (степень 0.7) окажется неоптимальной, можно скорректировать:

### Более консервативная (степень 0.6)
- Еще более быстрый рост в начале
- Еще более медленный рост в конце
- BTR 200 → BP ~1095 (вместо 1106)
- BTR 1000 → BP ~1410 (вместо 1443)

### Более агрессивная (степень 0.8)
- Более равномерное распределение
- BTR 200 → BP ~1116 (вместо 1106)
- BTR 1000 → BP ~1474 (вместо 1443)

### Линейная (степень 1.0)
- Равномерный рост по всему диапазону
- BTR 200 → BP ~1135
- BTR 1000 → BP ~1532

## Заключение

Предложенная формула со скошенным распределением обеспечивает:
- ✅ **Ограничение сверху:** Максимальный стартовый рейтинг 1600 для всех топ-игроков
- ✅ **Адекватный старт:** Профессионалы получают рейтинг выше любителей (1000-1600)
- ✅ **Скошенное распределение:** Быстрый рост в начале, замедление к концу
- ✅ **Справедливость:** Все топ-игроки (BTR ≥ 1500) получают одинаковый максимум
- ✅ **Безопасность:** Ограничение 1600 предотвращает доминирование новичков
- ✅ **Гибкость:** Можно скорректировать степень (0.6-0.8) при необходимости
