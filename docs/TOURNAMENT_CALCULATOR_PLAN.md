---
description: Tournament Calculator (планировщик) — спецификация и план реализации
---

# Tournament Calculator — спецификация и план реализации

## 1. Цель
Дать организатору инструмент, чтобы **до фактического старта турнира** оценить и подобрать оптимальные параметры проведения:

- формат (RR / KO / King / multi-stage в будущем)
- формат счёта (и, как следствие, средняя длительность матча)
- минимально/комфортно необходимое число кортов
- время начала и ожидаемое время окончания
- уложится ли турнир в окно аренды / световой день
- наглядный «скелет» расписания (черновик) с плейсхолдерами + экспорт в PDF

Калькулятор должен поддерживать сценарий «не знаю точное число участников/пар» — можно играть параметрами и смотреть влияние.

## 2. Не-цели (на MVP)
- **Не** заменять полноценное расписание для live-турнира.
- **Не** пытаться идеально предсказывать длительность матчей по рейтингу/уровню (пока только модель по сетам/тайм-слотам).
- **Не** моделировать все экзотические форматы (старт с половины сетки, квалификация и т.д.) на MVP.

## 3. Основные пользовательские сценарии

### 3.1 «Подобрать формат под окно времени»
Организатор задаёт:
- N участников/пар (диапазон или точное)
- доступность кортов (сколько кортов и в какие часы)
- формат счёта (или среднюю длительность матча)

Система показывает:
- число матчей
- оценку длительности турнира
- оценку времени окончания
- риски/буфер

### 3.2 «Сравнить RR vs KO vs King»
Организатор выбирает несколько пресетов, калькулятор сравнивает:
- количество матчей
- гарантированное число игр на участника
- длительность
- требуемые корты

### 3.3 «Сделать наглядный черновик расписания и выгрузить в PDF»
Калькулятор генерирует черновик расписания:
- вместо ФИО: плейсхолдеры (Seed/Team/Pair)
- сетка/таймлайн как в обычном расписании
- экспорт в PDF

## 4. UX / UI (предложение)

### 4.1 Точка входа
- Кнопка/раздел: **«Калькулятор турнира»**
- Доступен:
  - в турнире на статусе `created` и/или на этапе настройки
  - возможно, как отдельная страница без привязки к турниру (опционально)

### 4.2 Структура экрана (одностраничный мастер)
Левая колонка — параметры, правая — результаты.

**Левая колонка (параметры):**
- **Участники**
  - режим: singles / doubles
  - N (точное) и/или диапазон (min/max)
- **Формат**
  - RR / KO / King (multi-stage позже)
  - RR: число групп (или автоподбор)
  - KO: размер сетки / 3-е место (да/нет)
- **Матч**
  - формат счёта (preset) или «средняя длительность матча (мин)»
  - буфер на смену игроков/переходы (мин)
- **Площадки**
  - число кортов (фиксированное)
  - (позже) доступность по времени: интервалы с разным числом кортов
- **Время**
  - время начала
  - желаемое время окончания (опционально)

**Правая колонка (результаты):**
- карточки-итоги:
  - матчей всего
  - «раундов»/запусков (условно)
  - минимальное время окончания
  - рекомендуемый буфер
- предупреждения:
  - «не укладывается в окно»
  - «слишком мало гарантированных игр»
- кнопки:
  - «Сгенерировать черновик расписания»
  - «Экспорт PDF» (черновика)

## 5. Данные и модели

### 5.1 Входные параметры (DTO)
Рекомендуемый DTO для расчёта:
- `participants_mode`: singles/doubles
- `participants_count`: int
- `system`: rr/ko/king
- `rr_groups_count`: int | null
- `match_duration_minutes`: int
- `buffer_minutes`: int
- `courts_count`: int
- `start_time`: HH:MM
- (позже) `court_availability`: [{ from:HH:MM, to:HH:MM, courts:int }]

### 5.2 Выход расчёта (DTO)
- `matches_total`
- `guaranteed_matches_per_participant` (если применимо)
- `estimated_end_time` (min/avg/max — если хотим диапазон)
- `required_courts_for_deadline` (если задан deadline)
- `notes` / `warnings`
- `draft_schedule_preview` (опционально, ссылка или встроенный лёгкий preview)

## 6. Расчётная модель (первый приближенный вариант)

### 6.1 Базовые определения
- `slot_minutes = match_duration_minutes + buffer_minutes`
- Пропускная способность: `courts_count` матчей параллельно

### 6.2 Оценка количества матчей

**KO:**
- если ровно N участников и это степень двойки: `matches = N - 1` (+ матч за 3-е место опционально)
- если N не степень двойки: аппроксимация через ближайшую степень двойки и byes (на MVP можно упрощённо)

**RR:**
- для каждой группы размера G: `G*(G-1)/2`
- итог = сумма по группам

**King:**
- зависит от реализации системы в продукте. На MVP можно:
  - либо считать как RR с малым числом матчей на игрока,
  - либо считать через параметр «матчей на участника» (например 4/5/6)

### 6.3 Оценка длительности
- `total_slots = ceil(matches_total / courts_count)`
- `total_minutes = total_slots * slot_minutes`
- `estimated_end = start_time + total_minutes`

### 6.4 Диапазон min/avg/max
Опционально:
- min = `slot_minutes * ceil(matches/courts)`
- avg = min * коэффициент (например 1.1)
- max = min * коэффициент (например 1.25)

Важно: коэффициенты должны быть настраиваемыми (в админке или конфиге), чтобы их можно было подстроить по статистике.

## 7. Генерация черновика расписания (preview)

### 7.1 Плейсхолдеры
- singles: `Игрок 1..N`
- doubles: `Пара 1..N` (или `Команда 1..N`)
- KO: `Seed 1..N`

### 7.2 Принцип генерации
На MVP:
- генерируем «пул матчей» с плейсхолдерами
- создаём сетку расписания (runs x courts) тем же механизмом, что уже есть для расписания
- делаем авто-расстановку по ячейкам (как сейчас)

Цель: **наглядность**, а не идеальная спортивная логика.

## 8. Экспорт PDF
- использовать текущий механизм HTML/CSS -> PDF
- пометка в шапке: «Черновик / Пример»

## 9. Архитектура реализации (предложение)

### 9.1 Backend
- новый endpoint:
  - `POST /tournaments/{id}/calculator/preview/` → расчёт + warnings
  - `POST /tournaments/{id}/calculator/draft_schedule/` → создаёт черновик расписания (schedule) с плейсхолдерами

(Альтернатива: вообще без сохранения, только preview, и отдельная кнопка «создать черновик».)

### 9.2 Frontend
- новая страница `TournamentCalculatorPage`
- переиспользование компонентов отображения расписания (grid) для preview

## 10. Пошаговый план MVP

### MVP-0 (быстро, 1-2 дня)
- только расчёт времени без генерации сетки
- ввод: N, system, match_duration, buffer, courts, start_time
- вывод: matches_total, estimated_end, warnings

### MVP-1 (планировщик + черновик)
- генерация черновика расписания с плейсхолдерами
- preview в гриде
- экспорт PDF

### MVP-2 (переменное число кортов по времени)
- court_availability интервалами
- перерасчёт capacity по интервалам

### MVP-3 (несколько стадий)
- мастер-турниры/стадии
- расчёт по стадиям (RR -> KO)

## 11. Открытые вопросы
- Нужно ли учитывать реальные ограничения игроков (не могут играть одновременно)?
  - На MVP: нет, только оценка.
- Нужно ли моделировать «перерывы/обеды/церемонии»?
  - На MVP: как глобальные паузы.
- Нужна ли поддержка нескольких дней?
  - Позже.
