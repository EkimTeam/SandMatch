# План разработки SandMatch (MVP0 → MVP1)

Документ основан на `D:\Техническое Задание SandMatch.txt` и `D:\Подробный план реализации SandMatch.txt`.

## Архитектура и стек

- Бэкенд: Django (Python 3.11+), Django Admin, DRF для API
- БД: PostgreSQL 14+
- Фронтенд: SPA на Vite + React 18 + TypeScript (+ Tailwind CSS), html2canvas для PNG‑экспорта
- Контейнеризация: Docker + docker-compose (MVP0)
- Веб‑сервер (MVP1): Nginx + Gunicorn
- Логи/мониторинг (MVP1): Yandex Cloud Monitoring/Logs, Sentry (опц.)
- Секреты: .env локально; GitHub Secrets + YC Lockbox на прод
- Статика/медиа (MVP1): YC Object Storage (S3)

## Модель данных (базовая)

- players.Player: name, timestamps
- teams.Team: player_1, player_2 (уникальность состава)
- tournaments.Tournament: name, date, status, type, groups_count, set_format, ruleset, planned_participants
- tournaments.TournamentEntry: tournament, team, is_out_of_competition
- matches.Match: tournament, round_name, order_in_round, team_1, team_2, winner
- matches.MatchSet: match, score1, score2, tie_break
- tournaments.Ruleset, tournaments.SetFormat — справочники

## Ключевая логика

- Круговая система: генерация расписания, ввод счёта, сортировка по регламенту
- Олимпийская система: сетка, ввод счёта, авто‑продвижение победителя, матч за 3‑е место
- История: список завершенных, детали, история игрока

### Реализовано в MVP0 (актуально)
- Страница турнира (группы) с вводом счёта (MVP: один сет) и зеркальным отображением результатов.
- Технические столбцы считаются на фронтенде из отображаемых данных: Победы, Сеты, Сеты соот., Геймы, Геймы соот.
- Ранжирование мест по каскаду: Победы → личная встреча → Сеты соот. → личная встреча → Геймы соот. → личная встреча → спец‑тайбрейкеры (Петров Михаил → рейтинг → алфавит).
- Экспорт PNG («Поделиться»): снимается текущий вид таблиц; в картинке есть шапка (заголовок + логотип) и нижний футер («SandMatch» слева, «скоро онлайн» справа); служебные элементы в выгрузку не попадают.

### TODO/ограничения
- Чемпионский тай‑брейк: в агрегатах «Сеты» должен учитываться как 1:0/0:1 (сейчас TODO на фронтенде).
- Поддержка нескольких сетов и TB‑значений в UI ввода результатов.
- Правила ранжирования перенести в конфигурируемый пресет `Ruleset` (сейчас логика реализована на фронтенде для групп).
- Публичный шаринг‑URL и печатная версия.
- Экспорт результатов: html шаблон + html2canvas → PNG
- Завершение турнира: статус completed, пересчет рейтинга (синхронно в MVP)

## Что уже сделано (MVP0, текущий этап)

- UI: навигация (`Турниры`, `Игроки`, `Статистика`), адаптивный базовый шаблон и логотип.
- Страница `Турниры`: активные и история, модальное окно «Начать новый турнир» с валидацией для круговой.
- Страница турнира: групповые таблицы и «порядок игр», переключатели колонок.
- Ввод счёта (MVP: один сет) через модальное окно:
  - зеркальное отображение счёта во второй ячейке (например, 6:4 → 4:6);
  - запись в БД, установка `winner`, `status=completed`, `finished_at`;
  - восстановление счёта из БД при перезагрузке/возврате на страницу;
  - автопересчёт и отрисовка технических столбцов (победы/сеты/соотношения/геймы/место) после ввода и при загрузке;
  - отображение статуса «идет» для начатых матчей без результата.
- Действия турнира: «Завершить», «Удалить», «Поделиться» (заглушка).
- Admin action: «Сгенерировать расписание (круговая)» и команда `generate_round_robin`.
- Пресеты: команды `seed_rulesets`, `reset_presets`.

## Ближайшие задачи

- Ввод результатов матча с поддержкой нескольких сетов и тай‑брейков по `SetFormat` (валидация, UI нескольких строк).
- Кнопка «Сгенерировать расписание» на странице турнира (без захода в админку).
- Сортировка/ранжирование по `Ruleset`, включая h2h при равенстве — как на бэке (сервис), так и в UI.
- Экспорт/«Поделиться»: печатная версия и PNG, добавление `favicon`.
- Улучшение UX модалок (клавиатура, фокус, Escape, закрытие по клику вне, ошибки API).

## MVP1 (Yandex Cloud)

- ВМ, Managed PostgreSQL, Object Storage, домен/SSL
- Контейнеры: web + nginx + миграции; Gunicorn
- CI/CD: GitHub Actions (lint/test/build/push/deploy)
- Мониторинг/логи, бэкапы, политика секретов
- Критерии готовности:
  - Доступ по HTTPS, деплой без простоя
  - Бэкапы протестированы, базовые алерты

## Риски

- Сложность регламентов — ограничить пресетами в MVP
- Производительность больших таблиц — индексы, пагинация
- Кроссбраузерность html2canvas — тест на популярных браузерах

## Следующие шаги

- Реализация моделей и CRUD
- Генерация таблиц/сеток, ввод счетов
- История и экспорт результатов
