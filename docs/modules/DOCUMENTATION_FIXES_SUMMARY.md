# Сводка исправлений документации

**Дата:** 5 января 2026

## Исправления в коде

### ✅ Расчет рейтинга пары

**Проблема:** В нескольких местах кода использовалась **сумма** рейтингов вместо **среднего арифметического**.

**Исправлено в файлах:**
1. `apps/tournaments/views.py` - функция `_team_rating()` (строки 895-903)
2. `apps/tournaments/services/stats.py` - расчет `team_rating` (строки 352-356)
3. `apps/tournaments/services/knockout.py` - функция `_get_team_rating()` (строки 388-402)

**Правильная формула:** `round((r1 + r2) / 2)` для пар, `r1` для одиночек

**Места где уже было правильно:**
- `apps/tournaments/api_views.py` (строки 676-678, 2075-2077, 2839-2841)
- `apps/players/services/rating_service.py` (строки 26-28)

---

## Критические исправления документации

### 1. KNOCKOUT_03_SEEDING.md

**Исправление:** Рейтинг пары = среднее арифметическое с округлением до целых
```
Было: rating = player1.rating + player2.rating
Стало: rating = round((player1.rating + player2.rating) / 2)
```

### 2. TEAMS_DETAILED.md

**Исправление:** То же самое - рейтинг пары = среднее арифметическое

### 3. KING.md

**Исправления:**
- Убрать упоминание "виртуальных Team" - в King используются обычные Team с player_1 = игрок, player_2 = NULL
- Убрать упоминание "Побед подряд (streak)" и "Время на корте" - в коде этого нет
- Оставить только "Общее количество побед"

### 4. KING_DETAILED.md

**Дополнения:**
- Добавить описание модели MatchSet
- Добавить формат отображения расписания "A+B vs C+D"
- Добавить описание режимов "M-/G+/NO"
- Добавить раздел про определение победителя и регламенты
- Добавить раздел про действия по статусам (Created/Active/Completed) и роли

### 5. RATING_BTR_DETAILED.md

**Исправления:**
- Убрать упоминание функции `btr_to_bp()` - её нет в коде
- Убрать раздел "Конвертация в BP" или указать, что конвертация не реализована

### 6. RATING_BP_DETAILED.md

**Критические исправления:**
- Шкала BP: не от 1.0 до 5.0 (нужно проверить реальную шкалу в коде)
- Хранение: не умножается на 1000 (нужно проверить как хранится)
- Функция `get_bp_rating()` - проверить существование
- Раздел "Формула расчета" - переписать на основе реального кода
- Убрать "Цветовую индикацию" если не используется

### 7. PLAYERS_DETAILED.md

**Исправления:**
- Заменить `middle_name` на `patronymic` (в модели используется patronymic)
- Проверить наличие кнопки "Добавить игрока" на PlayersPage.tsx
- Убрать функции `import_players_from_excel` и `export_players_to_excel` - их нет

### 8. MATCHES_DETAILED.md

**Дополнения:**
- Описать принцип расстановки `order_in_round` для круговой системы и King
- Указать, что в MatchSet поля записываются в порядке team_1 vs team_2 из Match

### 9. REGISTRATION_TELEGRAM_DETAILED.md

**Проверка:** Проверить соответствие команд бота реальному коду в `apps/telegram_bot/bot/handlers/`

Реальные команды:
- `/start` - handlers/start.py
- `/help` - handlers/help.py  
- `/link` - handlers/link.py
- `/profile` - handlers/profile.py
- `/tournaments` - handlers/tournaments.py

### 10. PLAYER_STATS_DETAILED.md

**Исправление:** Убрать упоминание PDF-экспорта - его нет в коде

### 11. KNOCKOUT_05_FRONTEND.md + ROUND_ROBIN + KING

**Дополнение:** Добавить описание модальных окон:
- Модальное окно ввода счета (ScoreModal)
- Модальное окно добавления участника
- Модальное окно настроек турнира

### 12. Даты во всех документах

**Исправление:** Заменить "5 января 2026" на "5 января 2026"

---

## Статус выполнения

- ✅ Код исправлен (расчет рейтинга пары)
- ⏳ Документация в процессе исправления
- ⏳ Требуется проверка patronymic (большой объем изменений)

---

## Примечания

1. **patronymic vs middle_name:** Пользователь хочет заменить `patronymic` на `middle_name` везде в коде и документации. Это большая работа, требующая:
   - Изменение модели Player
   - Создание миграции
   - Замена во всех API, сериализаторах, frontend
   - Обновление документации

2. **Приоритет исправлений:**
   - Высокий: расчет рейтинга (✅ выполнено), описание моделей
   - Средний: описание UI/UX, модальные окна
   - Низкий: даты в документах
